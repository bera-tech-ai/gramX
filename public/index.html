<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>gramX - Complete Messaging</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0088cc 0%, #0055cc 100%);
            height: 100vh;
            overscroll-behavior: none;
            transition: background 0.3s ease;
        }

        body.dark-theme {
            background: linear-gradient(135deg, #0a1a2a 0%, #05121f 100%);
        }

        .screen { display: none; width: 100%; height: 100%; flex-direction: column; }
        .screen.active { display: flex; }

        /* AUTH SCREENS */
        .auth-container { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            padding: 20px; 
            background: white; 
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        }

        .dark-theme .auth-container {
            background: #1e2c3a;
            color: white;
        }

        .auth-box { width: 100%; max-width: 340px; }
        .auth-title { 
            text-align: center; 
            color: #0088cc; 
            font-size: 32px; 
            font-weight: 800; 
            margin-bottom: 30px;
            letter-spacing: -0.5px;
        }

        .dark-theme .auth-title {
            color: #4eb6e9;
        }

        .auth-input { 
            width: 100%; 
            padding: 16px; 
            margin-bottom: 16px; 
            border: 1px solid #e0e0e0; 
            border-radius: 12px; 
            font-size: 16px; 
            background: #f8f9fa; 
            transition: all 0.2s ease;
        }

        .dark-theme .auth-input {
            background: #2a3b4d;
            border-color: #3a4b5d;
            color: white;
        }

        .auth-input:focus {
            border-color: #0088cc;
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 136, 204, 0.1);
            outline: none;
        }

        .dark-theme .auth-input:focus {
            border-color: #4eb6e9;
            background: #2a3b4d;
            box-shadow: 0 0 0 3px rgba(78, 182, 233, 0.2);
        }

        .auth-button { 
            width: 100%; 
            padding: 16px; 
            background: #0088cc; 
            color: white; 
            border: none; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            margin-bottom: 20px; 
            transition: all 0.2s ease;
        }

        .dark-theme .auth-button {
            background: #4eb6e9;
        }

        .auth-button:active {
            transform: scale(0.98);
            background: #0066aa;
        }

        .dark-theme .auth-button:active {
            background: #3a95c7;
        }

        .auth-switch { text-align: center; color: #666; }
        .dark-theme .auth-switch { color: #aaa; }
        .auth-switch a { color: #0088cc; text-decoration: none; font-weight: 500; }
        .dark-theme .auth-switch a { color: #4eb6e9; }
        .error-message {
            color: #ff3b30;
            text-align: center;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }

        /* Profile picture selection */
        .avatar-selection {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
            width: 100%;
        }

        .avatar-option-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dark-theme .avatar-option-btn {
            background: #2a3b4d;
            border-color: #3a4b5d;
        }

        .avatar-option-btn:active {
            background: #f8f9fa;
        }

        .dark-theme .avatar-option-btn:active {
            background: #3a4b5d;
        }

        .avatar-option-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #0088cc;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .dark-theme .avatar-option-icon {
            background: #4eb6e9;
        }

        .avatar-option-text {
            flex: 1;
        }

        .avatar-option-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        .dark-theme .avatar-option-title {
            color: white;
        }

        .avatar-option-desc {
            font-size: 14px;
            color: #666;
        }

        .dark-theme .avatar-option-desc {
            color: #aaa;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 15px auto;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 3px solid #0088cc;
            background-size: cover;
            background-position: center;
        }

        .dark-theme .avatar-preview {
            background: #2a3b4d;
            border-color: #4eb6e9;
        }

        .avatar-preview-placeholder {
            font-size: 32px;
            color: #999;
        }

        .dark-theme .avatar-preview-placeholder {
            color: #7a8a9c;
        }

        /* Music download section */
        .music-downloader {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .dark-theme .music-downloader {
            background: #2a3b4d;
        }

        .music-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .music-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .dark-theme .music-input {
            background: #1e2c3a;
            border-color: #3a4b5d;
            color: white;
        }

        .music-search-button {
            padding: 12px 15px;
            background: #0088cc;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .dark-theme .music-search-button {
            background: #4eb6e9;
        }

        .music-results {
            display: none;
        }

        .music-thumbnail {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .music-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .dark-theme .music-title {
            color: white;
        }

        .music-artist {
            color: #666;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .dark-theme .music-artist {
            color: #aaa;
        }

        .music-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .music-option {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dark-theme .music-option {
            background: #1e2c3a;
        }

        .music-option:active {
            background: #e9ecef;
        }

        .dark-theme .music-option:active {
            background: #2d3e50;
        }

        .music-option-quality {
            font-weight: 600;
            color: #0088cc;
            margin-bottom: 5px;
        }

        .dark-theme .music-option-quality {
            color: #4eb6e9;
        }

        .music-option-size {
            font-size: 12px;
            color: #666;
        }

        .dark-theme .music-option-size {
            color: #aaa;
        }

        .music-downloading {
            text-align: center;
            padding: 15px;
            display: none;
        }

        .music-download-progress {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }

        .dark-theme .music-download-progress {
            background: #2d3e50;
        }

        .music-download-bar {
            height: 100%;
            background: #0088cc;
            width: 0%;
            transition: width 0.3s ease;
        }

        .dark-theme .music-download-bar {
            background: #4eb6e9;
        }

        .music-download-status {
            font-size: 14px;
            color: #666;
        }

        .dark-theme .music-download-status {
            color: #aaa;
        }

        .music-error {
            color: #ff3b30;
            text-align: center;
            padding: 10px;
            display: none;
        }

        /* CHAT LIST SCREEN */
        .chat-list-header {
            background: #0088cc;
            color: white;
            padding: 20px;
            text-align: center;
            font-weight: 700;
            font-size: 20px;
            position: relative;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .dark-theme .chat-list-header {
            background: #1e2c3a;
        }

        .header-buttons {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 10px;
        }

        .header-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 18px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .header-button:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.95);
        }

        .search-container {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .dark-theme .search-container {
            background: #1e2c3a;
            border-color: #2d3e50;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 18px;
            padding: 8px 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .dark-theme .search-box {
            background: #2a3b4d;
        }

        .search-box i {
            color: #999;
            margin-right: 8px;
        }

        .dark-theme .search-box i {
            color: #7a8a9c;
        }

        .search-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 16px;
            background: transparent;
        }

        .dark-theme .search-input {
            color: white;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .dark-theme .tabs {
            background: #1e2c3a;
            border-color: #2d3e50;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .dark-theme .tab {
            color: #aaa;
        }

        .tab.active {
            color: #0088cc;
            border-bottom-color: #0088cc;
        }

        .dark-theme .tab.active {
            color: #4eb6e9;
            border-bottom-color: #4eb6e9;
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
            background: white;
        }

        .dark-theme .conversations-list {
            background: #15202b;
        }

        .conversation-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        .dark-theme .conversation-item {
            border-color: #253341;
        }

        .conversation-item:active {
            background: #f8f9fa;
        }

        .dark-theme .conversation-item:active {
            background: #1e2c3a;
        }

        .conversation-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0088cc 0%, #0055cc 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            background-size: cover;
            background-position: center;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dark-theme .conversation-name {
            color: white;
        }

        .verified-badge {
            color: #0088cc;
            font-size: 14px;
        }

        .dark-theme .verified-badge {
            color: #4eb6e9;
        }

        .conversation-preview {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .dark-theme .conversation-preview {
            color: #8899a6;
        }

        .conversation-meta {
            text-align: right;
            margin-left: 8px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .conversation-time {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .dark-theme .conversation-time {
            color: #8899a6;
        }

        .unread-badge {
            background: #ff3b30;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .muted-icon {
            color: #999;
            font-size: 14px;
        }

        .dark-theme .muted-icon {
            color: #7a8a9c;
        }

        .pinned-icon {
            color: #999;
            font-size: 14px;
            transform: rotate(45deg);
        }

        .dark-theme .pinned-icon {
            color: #7a8a9c;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .dark-theme .empty-state {
            color: #8899a6;
        }
        
        .empty-icon {
            font-size: 60px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* ONLINE USERS LIST */
        .online-users-header { 
            padding: 15px; 
            background: #f8f9fa; 
            font-weight: 600; 
            color: #666; 
            border-bottom: 1px solid #e0e0e0; 
        }

        .dark-theme .online-users-header {
            background: #1e2c3a;
            color: #aaa;
            border-color: #2d3e50;
        }

        .users-list { flex: 1; overflow-y: auto; background: white; }
        .dark-theme .users-list { background: #15202b; }
        .user-item { 
            padding: 16px; 
            border-bottom: 1px solid #f0f0f0; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            cursor: pointer; 
            transition: all 0.2s ease;
        }

        .dark-theme .user-item {
            border-color: #253341;
        }

        .user-item:active { background: #f8f9fa; }
        .dark-theme .user-item:active { background: #1e2c3a; }
        .user-avatar { 
            width: 48px; 
            height: 48px; 
            border-radius: 50%; 
            background: linear-gradient(135deg, #0088cc 0%, #0055cc 100%); 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            font-size: 18px; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            background-size: cover;
            background-position: center;
        }
        .user-info { flex: 1; }
        .user-name { font-weight: 600; font-size: 16px; display: flex; align-items: center; gap: 5px; }
        .dark-theme .user-name { color: white; }
        .user-status { font-size: 13px; color: #666; display: flex; align-items: center; }
        .dark-theme .user-status { color: #8899a6; }
        .online-dot { 
            width: 10px; 
            height: 10px; 
            background: #4CAF50; 
            border-radius: 50%; 
            margin-right: 5px; 
            display: inline-block; 
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
        }
        .offline-dot { 
            width: 10px; 
            height: 10px; 
            background: #ccc; 
            border-radius: 50%; 
            margin-right: 5px; 
            display: inline-block; 
        }

        /* CHAT SCREEN */
        .chat-header { 
            background: #0088cc; 
            color: white; 
            padding: 16px; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .dark-theme .chat-header {
            background: #1e2c3a;
        }

        .back-button { 
            background: none; 
            border: none; 
            color: white; 
            font-size: 20px; 
            cursor: pointer; 
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .back-button:active {
            background: rgba(255, 255, 255, 0.1);
        }
        .chat-info { flex: 1; }
        .chat-name { font-weight: 600; font-size: 17px; display: flex; align-items: center; gap: 5px; }
        .chat-status { 
            font-size: 13px; 
            opacity: 0.9; 
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .messages-container { 
            flex: 1; 
            padding: 16px; 
            overflow-y: auto; 
            background: #e6ebf5; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }

        .dark-theme .messages-container {
            background: #0d151f;
        }

        .message { 
            max-width: 80%; 
            padding: 12px 16px; 
            border-radius: 12px; 
            animation: messageSlide 0.3s ease-out; 
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        @keyframes messageSlide { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .my-message { 
            background: #d3eddb; 
            align-self: flex-end; 
            border-bottom-right-radius: 4px; 
        }

        .dark-theme .my-message {
            background: #005c4b;
            color: white;
        }

        .their-message { 
            background: white; 
            align-self: flex-start; 
            border-bottom-left-radius: 4px; 
        }

        .dark-theme .their-message {
            background: #2a3b4d;
            color: white;
        }

        .message-sender { 
            font-weight: 600; 
            font-size: 14px; 
            color: #0088cc; 
            margin-bottom: 4px; 
        }

        .dark-theme .message-sender {
            color: #4eb6e9;
        }

        .message-text { font-size: 16px; line-height: 1.4; }
        .message-time { 
            font-size: 11px; 
            color: #7d7d7d; 
            text-align: right; 
            margin-top: 4px; 
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
        }

        .dark-theme .message-time {
            color: #8899a6;
        }

        .message-status {
            font-size: 11px;
        }
        .message-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .message:hover .message-actions {
            opacity: 1;
        }
        .message-action {
            background: rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            color: #666;
        }

        .dark-theme .message-action {
            background: rgba(255, 255, 255, 0.1);
            color: #aaa;
        }

        .system-message { 
            text-align: center; 
            color: #7d7d7d; 
            font-size: 13px; 
            margin: 8px 0; 
            font-style: italic; 
        }

        .dark-theme .system-message {
            color: #8899a6;
        }

        .message-input-container { 
            padding: 12px 16px; 
            background: #f0f2f5; 
            border-top: 1px solid #e0e0e0; 
            display: flex; 
            gap: 8px; 
            align-items: center; 
        }

        .dark-theme .message-input-container {
            background: #1e2c3a;
            border-color: #2d3e50;
        }

        .message-input { 
            flex: 1; 
            padding: 12px 16px; 
            border: none; 
            border-radius: 22px; 
            font-size: 16px; 
            background: white; 
            outline: none; 
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .dark-theme .message-input {
            background: #2a3b4d;
            color: white;
        }

        .input-button { 
            background: transparent; 
            color: #0088cc; 
            border: none; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            font-size: 18px; 
            transition: all 0.2s ease;
        }

        .dark-theme .input-button {
            color: #4eb6e9;
        }

        .input-button:active {
            background: rgba(0, 136, 204, 0.1);
        }

        .dark-theme .input-button:active {
            background: rgba(78, 182, 233, 0.1);
        }

        .send-button { 
            background: #0088cc; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            font-size: 18px; 
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .dark-theme .send-button {
            background: #4eb6e9;
        }

        .send-button:active {
            transform: scale(0.95);
            background: #0066aa;
        }

        .dark-theme .send-button:active {
            background: #3a95c7;
        }

        /* Floating action button */
        .floating-button {
            position: fixed;
            bottom: 70px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #0088cc;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .dark-theme .floating-button {
            background: #4eb6e9;
        }
        
        .floating-button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Bottom navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            padding: 8px 0;
            border-top: 1px solid #e0e0e0;
            z-index: 100;
        }

        .dark-theme .bottom-nav {
            background: #1e2c3a;
            border-color: #2d3e50;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 12px;
            cursor: pointer;
        }

        .dark-theme .nav-item {
            color: #7a8a9c;
        }
        
        .nav-item.active {
            color: #0088cc;
        }

        .dark-theme .nav-item.active {
            color: #4eb6e9;
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        /* Loading indicator */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Music button in message input */
        .music-button {
            background: transparent;
            color: #0088cc;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s ease;
        }

        .dark-theme .music-button {
            color: #4eb6e9;
        }

        .music-button:active {
            background: rgba(0, 136, 204, 0.1);
        }

        .dark-theme .music-button:active {
            background: rgba(78, 182, 233, 0.1);
        }

        /* Music message */
        .music-message {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 12px;
            margin: 5px 0;
        }

        .dark-theme .music-message {
            background: #2a3b4d;
        }

        .music-message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .music-message-icon {
            color: #ff3b30;
            font-size: 20px;
        }

        .music-message-title {
            font-weight: 600;
            color: #333;
        }

        .dark-theme .music-message-title {
            color: white;
        }

        .music-message-details {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .dark-theme .music-message-details {
            color: #aaa;
        }

        .music-message-url {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            word-break: break-all;
        }

        .dark-theme .music-message-url {
            color: #aaa;
        }

        .music-message-actions {
            display: flex;
            gap: 10px;
        }

        .music-message-button {
            padding: 8px 12px;
            background: #0088cc;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        .dark-theme .music-message-button {
            background: #4eb6e9;
        }

        /* Media attachment panel */
        .media-attachment-panel {
            position: absolute;
            bottom: 70px;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 15px;
            display: none;
            flex-direction: column;
            gap: 15px;
            z-index: 200;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .dark-theme .media-attachment-panel {
            background: #1e2c3a;
            border-color: #2d3e50;
        }

        .attachment-options {
            display: flex;
            justify-content: space-around;
        }

        .attachment-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border-radius: 12px;
            background: #f8f9fa;
            min-width: 80px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dark-theme .attachment-option {
            background: #2a3b4d;
        }

        .attachment-option:active {
            background: #e9ecef;
        }

        .dark-theme .attachment-option:active {
            background: #3a4b5d;
        }

        .attachment-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #0088cc;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .dark-theme .attachment-icon {
            background: #4eb6e9;
        }

        .attachment-label {
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        .dark-theme .attachment-label {
            color: #aaa;
        }

        /* Hidden file inputs */
        .file-input {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="screen active">
        <div class="auth-container">
            <div class="auth-box">
                <h1 class="auth-title">gramX</h1>
                <div class="error-message" id="login-error"></div>
                <input type="text" id="login-username" class="auth-input" placeholder="Username">
                <input type="password" id="login-password" class="auth-input" placeholder="Password">
                <button class="auth-button" onclick="login()">Login</button>
                <div class="auth-switch">
                    Don't have an account? <a href="#" onclick="showScreen('register-screen')">Register</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Screen -->
    <div id="register-screen" class="screen">
        <div class="auth-container">
            <div class="auth-box">
                <h1 class="auth-title">Create Account</h1>
                <div class="error-message" id="register-error"></div>
                <input type="text" id="register-username" class="auth-input" placeholder="Choose username">
                <input type="password" id="register-password" class="auth-input" placeholder="Choose password">
                
                <!-- Profile Picture Selection -->
                <div class="avatar-preview" id="avatar-preview">
                    <div class="avatar-preview-placeholder">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
                
                <div class="avatar-selection">
                    <div class="avatar-option-btn" onclick="openAvatarGallery()">
                        <div class="avatar-option-icon">
                            <i class="fas fa-image"></i>
                        </div>
                        <div class="avatar-option-text">
                            <div class="avatar-option-title">Choose from Gallery</div>
                            <div class="avatar-option-desc">Select a photo from your device</div>
                        </div>
                    </div>
                    
                    <div class="avatar-option-btn" onclick="openCamera()">
                        <div class="avatar-option-icon">
                            <i class="fas fa-camera"></i>
                        </div>
                        <div class="avatar-option-text">
                            <div class="avatar-option-title">Take Photo</div>
                            <div class="avatar-option-desc">Use your camera to take a picture</div>
                        </div>
                    </div>
                </div>
                
                <button class="auth-button" onclick="register()">Create Account</button>
                <div class="auth-switch">
                    Already have an account? <a href="#" onclick="showScreen('login-screen')">Login</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat List Screen -->
    <div id="chat-list-screen" class="screen">
        <div class="chat-list-header">
            gramX
            <div class="header-buttons">
                <button class="header-button" onclick="toggleSearch()">
                    <i class="fas fa-search"></i>
                </button>
                <button class="header-button" onclick="showSettings()">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
        
        <div class="search-container" id="search-container" style="display: none;">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" class="search-input" placeholder="Search" id="search-input">
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('conversations')">Chats</div>
            <div class="tab" onclick="showTab('online')">Online</div>
            <div class="tab" onclick="showTab('all')">All Users</div>
        </div>

        <!-- Conversations Tab -->
        <div id="conversations-tab" class="conversations-list">
            <div class="empty-state" id="no-conversations">
                <div class="empty-icon">üí¨</div>
                No conversations yet<br>
                <small>Start a chat with someone!</small>
            </div>
            <!-- Conversations will be listed here -->
        </div>

        <!-- Online Users Tab -->
        <div id="online-tab" class="users-list" style="display: none;">
            <div class="empty-state" id="no-online-users">
                <div class="empty-icon">üåê</div>
                No other users online
            </div>
            <!-- Online users will be listed here -->
        </div>

        <!-- All Users Tab -->
        <div id="all-tab" class="users-list" style="display: none;">
            <div class="empty-state" id="no-all-users">
                <div class="empty-icon">üë•</div>
                No other users available
            </div>
            <!-- All users will be listed here -->
        </div>
        
        <!-- Floating action button -->
        <div class="floating-button" onclick="showAllUsers()">
            <i class="fas fa-edit"></i>
        </div>
        
        <!-- Bottom navigation -->
        <div class="bottom-nav">
            <div class="nav-item active">
                <div class="nav-icon"><i class="fas fa-comment"></i></div>
                <div>Chats</div>
            </div>
            <div class="nav-item">
                <div class="nav-icon"><i class="fas fa-users"></i></div>
                <div>Contacts</div>
            </div>
            <div class="nav-item">
                <div class="nav-icon"><i class="fas fa-cog"></i></div>
                <div>Settings</div>
            </div>
        </div>
    </div>

    <!-- Private Chat Screen -->
    <div id="private-chat-screen" class="screen">
        <div class="chat-header">
            <button class="back-button" onclick="backToChatList()">‚Üê</button>
            <div class="chat-info">
                <div class="chat-name" id="chat-target-name">
                    User
                    <i class="fas fa-check-circle verified-badge"></i>
                </div>
                <div class="chat-status" id="chat-target-status">
                    <span class="online-dot" id="status-dot"></span>
                    <span id="status-text">online</span>
                </div>
            </div>
            <button class="header-button" onclick="showChatOptions()">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        </div>

        <div class="messages-container" id="private-messages-container">
            <!-- Private messages will appear here -->
            <div class="typing-indicator" id="typing-indicator">
                <span id="typing-user"></span> is typing
                <span class="typing-dots">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </span>
            </div>
        </div>

        <div class="message-input-container">
            <button class="input-button" onclick="toggleMediaPanel()">
                <i class="fas fa-paperclip"></i>
            </button>
            <button class="music-button" onclick="toggleMusicPanel()">
                <i class="fas fa-music"></i>
            </button>
            <input type="text" id="private-message-input" class="message-input" placeholder="Message" 
                onkeypress="handlePrivateKeyPress(event)"
                oninput="handleTyping()">
            <button class="input-button">
                <i class="fas fa-smile"></i>
            </button>
            <button class="send-button" onclick="sendPrivateMessage()" id="send-button">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>

        <!-- Music Download Panel -->
        <div class="media-attachment-panel" id="music-panel">
            <div class="music-downloader">
                <div class="music-input-container">
                    <input type="text" class="music-input" id="music-query" placeholder="Search for music or paste URL">
                    <button class="music-search-button" onclick="searchMusic()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>

                <div class="music-results" id="music-results">
                    <img src="" class="music-thumbnail" id="music-thumbnail">
                    <div class="music-title" id="music-title"></div>
                    <div class="music-artist" id="music-artist"></div>
                    
                    <div class="music-options" id="music-options">
                        <!-- Options will be populated here -->
                    </div>
                </div>

                <div class="music-downloading" id="music-downloading">
                    <div class="loading"></div>
                    <div class="music-download-progress">
                        <div class="music-download-bar" id="music-download-bar"></div>
                    </div>
                    <div class="music-download-status" id="music-download-status">Preparing download...</div>
                </div>

                <div class="music-error" id="music-error"></div>
            </div>
        </div>
    </div>

    <!-- Settings Screen -->
    <div id="settings-screen" class="screen">
        <div class="settings-header">
            <button class="settings-back-button" onclick="backToChatList()">‚Üê</button>
            Settings
        </div>
        
        <div class="settings-content">
            <div class="profile-section">
                <div class="profile-avatar" id="profile-avatar" onclick="openAvatarModal()">
                    <div class="profile-avatar-edit">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                <div class="profile-name" id="profile-name">User Name</div>
                <div class="profile-username" id="profile-username">@username</div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">Appearance</div>
                
                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-title">Theme</div>
                        <div class="settings-item-desc">Change the appearance of the app</div>
                    </div>
                    <select class="select-dropdown" id="theme-selector" onchange="changeTheme()">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="auto">Auto (System)</option>
                    </select>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">Notifications</div>
                
                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-title">Message Notifications</div>
                        <div class="settings-item-desc">Receive notifications for new messages</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="notifications-toggle" checked onchange="toggleNotifications()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-title">Sound</div>
                        <div class="settings-item-desc">Play sounds for new messages</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="sound-toggle" checked onchange="toggleSound()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">Privacy</div>
                
                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-title">Last Seen</div>
                        <div class="settings-item-desc">Who can see your last seen time</div>
                    </div>
                    <select class="select-dropdown" id="last-seen-selector" onchange="changeLastSeenPrivacy()">
                        <option value="everyone">Everyone</option>
                        <option value="contacts">My Contacts</option>
                        <option value="nobody">Nobody</option>
                    </select>
                </div>
                
                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-title">Profile Photo</div>
                        <div class="settings-item-desc">Who can see your profile photo</div>
                    </div>
                    <select class="select-dropdown" id="profile-photo-selector" onchange="changeProfilePhotoPrivacy()">
                        <option value="everyone">Everyone</option>
                        <option value="contacts">My Contacts</option>
                        <option value="nobody">Nobody</option>
                    </select>
                </div>
                
                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-title">Read Receipts</div>
                        <div class="settings-item-desc">Send read receipts for your messages</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="read-receipts-toggle" checked onchange="toggleReadReceipts()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <button class="logout-button" onclick="logout()">Log Out</button>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="avatar-input" class="file-input" accept="image/*" style="display: none;">
    <input type="file" id="camera-input" class="file-input" accept="image/*" capture="camera" style="display: none;">

    <script>
        // App state
        let socket = null;
        let currentUser = null;
        let currentTargetUser = null;
        let selectedAvatarFile = null;
        let currentMusicUrl = '';
        let musicDownloadInProgress = false;

        // UI Functions
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 3000);
        }

        // Profile picture functions
        function openAvatarGallery() {
            document.getElementById('avatar-input').click();
        }

        function openCamera() {
            document.getElementById('camera-input').click();
        }

        function setupAvatarInputListeners() {
            // Avatar gallery input
            document.getElementById('avatar-input').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleAvatarSelection(e.target.files[0]);
                }
            });

            // Camera input
            document.getElementById('camera-input').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleAvatarSelection(e.target.files[0]);
                }
            });
        }

        function handleAvatarSelection(file) {
            selectedAvatarFile = file;
            
            // Preview the selected image
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('avatar-preview');
                preview.style.backgroundImage = `url(${e.target.result})`;
                preview.innerHTML = '';
            };
            reader.readAsDataURL(file);
        }

        // Music download functions
        function toggleMusicPanel() {
            const panel = document.getElementById('music-panel');
            panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
            
            // Clear previous results when opening
            if (panel.style.display === 'flex') {
                document.getElementById('music-query').value = '';
                document.getElementById('music-results').style.display = 'none';
                document.getElementById('music-downloading').style.display = 'none';
                document.getElementById('music-error').style.display = 'none';
            }
        }

        function searchMusic() {
            const query = document.getElementById('music-query').value.trim();
            
            if (!query) {
                showMusicError('Please enter a search term or URL');
                return;
            }
            
            currentMusicUrl = query;
            
            // Show loading state
            document.getElementById('music-results').style.display = 'none';
            document.getElementById('music-downloading').style.display = 'flex';
            document.getElementById('music-download-status').textContent = 'Searching for music...';
            document.getElementById('music-error').style.display = 'none';
            
            // Check if it's a URL or a search query
            if (isValidUrl(query)) {
                fetchMusicInfoFromUrl(query);
            } else {
                searchMusicByQuery(query);
            }
        }

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function fetchMusicInfoFromUrl(url) {
            // For demo purposes, we'll simulate the response
            setTimeout(() => {
                document.getElementById('music-thumbnail').src = 'https://via.placeholder.com/300x150.png?text=Music+Thumbnail';
                document.getElementById('music-title').textContent = 'Sample Music Track';
                document.getElementById('music-artist').textContent = 'Artist Name';
                
                // Create download options
                const optionsContainer = document.getElementById('music-options');
                optionsContainer.innerHTML = '';
                
                // MP3 options
                const mp3Option = document.createElement('div');
                mp3Option.className = 'music-option';
                mp3Option.innerHTML = `
                    <div class="music-option-quality">MP3</div>
                    <div class="music-option-size">High Quality ‚Ä¢ 4.2 MB</div>
                `;
                mp3Option.onclick = () => downloadMusic('mp3', 'high');
                optionsContainer.appendChild(mp3Option);
                
                // MP4 options
                const mp4Option = document.createElement('div');
                mp4Option.className = 'music-option';
                mp4Option.innerHTML = `
                    <div class="music-option-quality">MP4</div>
                    <div class="music-option-size">Video ‚Ä¢ 12.5 MB</div>
                `;
                mp4Option.onclick = () => downloadMusic('mp4', 'video');
                optionsContainer.appendChild(mp4Option);
                
                // Show results
                document.getElementById('music-results').style.display = 'block';
                document.getElementById('music-downloading').style.display = 'none';
                
            }, 1500);
        }

        function searchMusicByQuery(query) {
            // Use the API you provided
            const apiUrl = `https://api.giftedtech.co.ke/api/search/yts?apikey=gifted&query=${encodeURIComponent(query)}`;
            
            // Show loading state
            document.getElementById('music-download-status').textContent = 'Searching for: ' + query;
            
            // In a real app, you would fetch from the API
            // For demo, we'll simulate the response
            setTimeout(() => {
                // Simulate API response
                const mockResponse = {
                    success: true,
                    data: [
                        {
                            title: "Easy to quit by Juice Wrld",
                            thumbnail: "https://via.placeholder.com/300x150.png?text=Juice+Wrld",
                            artist: "Juice Wrld",
                            duration: "3:45",
                            formats: [
                                { type: "mp3", quality: "high", size: "4.2MB" },
                                { type: "mp4", quality: "720p", size: "15.7MB" }
                            ]
                        },
                        {
                            title: "Another Song",
                            thumbnail: "https://via.placeholder.com/300x150.png?text=Another+Song",
                            artist: "Another Artist",
                            duration: "4:20",
                            formats: [
                                { type: "mp3", quality: "high", size: "5.1MB" },
                                { type: "mp4", quality: "1080p", size: "28.3MB" }
                            ]
                        }
                    ]
                };
                
                // Display first result for demo
                if (mockResponse.data && mockResponse.data.length > 0) {
                    const track = mockResponse.data[0];
                    
                    document.getElementById('music-thumbnail').src = track.thumbnail;
                    document.getElementById('music-title').textContent = track.title;
                    document.getElementById('music-artist').textContent = track.artist + ' ‚Ä¢ ' + track.duration;
                    
                    // Create download options
                    const optionsContainer = document.getElementById('music-options');
                    optionsContainer.innerHTML = '';
                    
                    track.formats.forEach(format => {
                        const optionElement = document.createElement('div');
                        optionElement.className = 'music-option';
                        optionElement.innerHTML = `
                            <div class="music-option-quality">${format.type.toUpperCase()}</div>
                            <div class="music-option-size">${format.quality} ‚Ä¢ ${format.size}</div>
                        `;
                        optionElement.onclick = () => downloadMusic(format.type, format.quality);
                        optionsContainer.appendChild(optionElement);
                    });
                    
                    // Show results
                    document.getElementById('music-results').style.display = 'block';
                    document.getElementById('music-downloading').style.display = 'none';
                } else {
                    showMusicError('No results found for: ' + query);
                }
                
            }, 2000);
        }

        function downloadMusic(format, quality) {
            if (musicDownloadInProgress) return;
            
            musicDownloadInProgress = true;
            
            // Show downloading state
            document.getElementById('music-results').style.display = 'none';
            document.getElementById('music-downloading').style.display = 'flex';
            document.getElementById('music-download-status').textContent = `Downloading ${format.toUpperCase()} (${quality})...`;
            
            // Build API URL based on format
            let apiUrl;
            if (isValidUrl(currentMusicUrl)) {
                // Download from URL
                if (format === 'mp3') {
                    apiUrl = `https://api.giftedtech.co.ke/api/download/mp3?apikey=gifted&url=${encodeURIComponent(currentMusicUrl)}`;
                } else {
                    apiUrl = `https://api.giftedtech.co.ke/api/download/mp4?apikey=gifted&url=${encodeURIComponent(currentMusicUrl)}`;
                }
            } else {
                // Download from search result
                if (format === 'mp3') {
                    apiUrl = `https://api.giftedtech.co.ke/api/download/mp3?apikey=gifted&query=${encodeURIComponent(currentMusicUrl)}`;
                } else {
                    apiUrl = `https://api.giftedtech.co.ke/api/download/mp4?apikey=gifted&query=${encodeURIComponent(currentMusicUrl)}`;
                }
            }
            
            // Simulate download progress
            simulateMusicDownloadProgress(apiUrl, format, quality);
        }

        function simulateMusicDownloadProgress(apiUrl, format, quality) {
            let progress = 0;
            const progressBar = document.getElementById('music-download-bar');
            
            const progressInterval = setInterval(() => {
                progress += 5;
                progressBar.style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    musicDownloadInProgress = false;
                    
                    // Download complete
                    document.getElementById('music-download-status').textContent = 'Download complete!';
                    
                    // In a real app, you would actually download the file from the API
                    // For this demo, we'll simulate a successful download
                    setTimeout(() => {
                        // Close the panel after a short delay
                        document.getElementById('music-panel').style.display = 'none';
                        
                        // Send the downloaded music as a message
                        sendMusicDownloadMessage(format, quality);
                    }, 1000);
                }
            }, 200);
        }

        function sendMusicDownloadMessage(format, quality) {
            if (!currentUser || !currentTargetUser) return;
            
            const messageData = {
                sender: currentUser,
                receiver: currentTargetUser,
                type: 'music',
                musicUrl: currentMusicUrl,
                format: format,
                quality: quality,
                timestamp: new Date()
            };
            
            // Add to chat
            addMusicMessageToChat(messageData);
            
            // Send via socket
            if (socket) {
                socket.emit('send-music-message', messageData);
            }
        }

        function addMusicMessageToChat(message) {
            const container = document.getElementById('private-messages-container');
            
            // Remove "no messages" system message if it exists
            const systemMessage = container.querySelector('.system-message');
            if (systemMessage && systemMessage.textContent.includes('No messages yet')) {
                systemMessage.remove();
            }
            
            const messageDiv = document.createElement('div');
            
            const isMyMessage = message.sender === currentUser;
            messageDiv.className = `message ${isMyMessage ? 'my-message' : 'their-message'}`;
            
            const time = new Date(message.timestamp).toLocaleTimeString([], { 
                hour: '2-digit', minute: '2-digit' 
            });
            
            let statusHtml = '';
            if (isMyMessage) {
                statusHtml = '<i class="fas fa-check"></i>';
            }
            
            messageDiv.innerHTML = `
                ${!isMyMessage ? `<div class="message-sender">${message.sender}</div>` : ''}
                <div class="music-message">
                    <div class="music-message-header">
                        <i class="fas fa-music music-message-icon"></i>
                        <div class="music-message-title">Music Download</div>
                    </div>
                    <div class="music-message-details">${message.format.toUpperCase()} ‚Ä¢ ${message.quality}</div>
                    <div class="music-message-url">${message.musicUrl}</div>
                    <div class="music-message-actions">
                        <button class="music-message-button" onclick="redownloadMusic('${message.musicUrl}', '${message.format}', '${message.quality}')">
                            <i class="fas fa-download"></i> Download Again
                        </button>
                    </div>
                </div>
                <div class="message-time">${time} ${statusHtml}</div>
            `;
            
            container.appendChild(messageDiv);
            
            // Make sure typing indicator stays at the bottom
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                container.appendChild(typingIndicator);
            }
            
            container.scrollTop = container.scrollHeight;
        }

        function redownloadMusic(url, format, quality) {
            // Open music panel with the URL
            document.getElementById('music-panel').style.display = 'flex';
            document.getElementById('music-query').value = url;
            currentMusicUrl = url;
            
            // Fetch info
            if (isValidUrl(url)) {
                fetchMusicInfoFromUrl(url);
            } else {
                searchMusicByQuery(url);
            }
            
            // After a delay, automatically select the previous format/quality
            setTimeout(() => {
                downloadMusic(format, quality);
            }, 2000);
        }

        function showMusicError(message) {
            const errorElement = document.getElementById('music-error');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        // Registration with profile picture
        async function register() {
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            
            if (!username || !password) {
                showError('register-error', 'Please enter both username and password');
                return;
            }
            
            if (!selectedAvatarFile) {
                showError('register-error', 'Please select a profile picture');
                return;
            }
            
            try {
                // In a real app, you would upload the avatar to your server
                // For this demo, we'll just store it in localStorage
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Save user with avatar
                    const userData = {
                        username: username,
                        password: password, // In a real app, you would hash this
                        avatar: e.target.result,
                        createdAt: new Date().toISOString()
                    };
                    
                    // Save to localStorage (simulating server storage)
                    localStorage.setItem(`gramx_user_${username}`, JSON.stringify(userData));
                    
                    showError('register-error', 'Registration successful! Please login.');
                    setTimeout(() => {
                        showScreen('login-screen');
                    }, 1500);
                };
                reader.readAsDataURL(selectedAvatarFile);
                
            } catch (error) {
                showError('register-error', 'Registration error. Please try again.');
            }
        }

        // Login function
        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            if (!username || !password) {
                showError('login-error', 'Please enter both username and password');
                return;
            }
            
            try {
                // Check if user exists in localStorage
                const userData = localStorage.getItem(`gramx_user_${username}`);
                if (!userData) {
                    showError('login-error', 'User not found');
                    return;
                }
                
                const user = JSON.parse(userData);
                if (user.password !== password) {
                    showError('login-error', 'Incorrect password');
                    return;
                }
                
                // Login successful
                currentUser = username;
                localStorage.setItem('gramx_current_user', username);
                
                // Initialize socket and show chat list
                initializeSocket();
                showScreen('chat-list-screen');
                
            } catch (error) {
                showError('login-error', 'Login error. Please try again.');
            }
        }

        // Initialize socket (simulated for demo)
        function initializeSocket() {
            console.log('Socket initialized for user:', currentUser);
            // In a real app, you would connect to your WebSocket server here
        }

        // Initialize the app when page loads
        window.onload = function() {
            // Check if user was previously logged in
            const savedUser = localStorage.getItem('gramx_current_user');
            if (savedUser) {
                document.getElementById('login-username').value = savedUser;
                currentUser = savedUser;
                initializeSocket();
                showScreen('chat-list-screen');
            }
            
            // Setup avatar input listeners
            setupAvatarInputListeners();
        };
    </script>
</body>
</html>
