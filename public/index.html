<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>gramX - Complete Messaging</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6a11cb;
            --primary-dark: #4a08a3;
            --primary-light: #8a2be2;
            --secondary: #ff6b6b;
            --accent: #4ecdc4;
            --background: #121212;
            --surface: #1e1e1e;
            --surface-light: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --error: #cf6679;
            --success: #4caf50;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            height: 100vh;
            overscroll-behavior: none;
        }

        .screen { display: none; width: 100%; height: 100%; flex-direction: column; }
        .screen.active { display: flex; }

        /* AUTH SCREENS */
        .auth-container { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            padding: 20px; 
            background: var(--surface); 
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        }

        .auth-box { width: 100%; max-width: 340px; }
        .auth-title { 
            text-align: center; 
            color: var(--primary-light); 
            font-size: 32px; 
            font-weight: 800; 
            margin-bottom: 30px;
            letter-spacing: -0.5px;
            text-shadow: 0 0 10px rgba(138, 43, 226, 0.5);
        }

        .auth-input { 
            width: 100%; 
            padding: 16px; 
            margin-bottom: 16px; 
            border: 1px solid var(--surface-light); 
            border-radius: 12px; 
            font-size: 16px; 
            background: var(--surface-light); 
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .auth-input:focus {
            border-color: var(--primary);
            background: var(--surface);
            box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.2);
            outline: none;
        }

        .auth-button { 
            width: 100%; 
            padding: 16px; 
            background: var(--primary); 
            color: white; 
            border: none; 
            border-radius: 12px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            margin-bottom: 20px; 
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(106, 17, 203, 0.3);
        }

        .auth-button:active {
            transform: scale(0.98);
            background: var(--primary-dark);
        }

        .auth-switch { text-align: center; color: var(--text-secondary); }
        .auth-switch a { color: var(--primary-light); text-decoration: none; font-weight: 500; }
        .error-message {
            color: var(--error);
            text-align: center;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }

        /* CHAT LIST SCREEN */
        .chat-list-header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
            font-weight: 700;
            font-size: 20px;
            position: relative;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .header-buttons {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 10px;
        }

        .header-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 18px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .header-button:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.95);
        }

        .search-container {
            padding: 10px 15px;
            background: var(--surface);
            border-bottom: 1px solid var(--surface-light);
        }

        .search-box {
            display: flex;
            align-items: center;
            background: var(--surface-light);
            border-radius: 18px;
            padding: 8px 15px;
        }

        .search-box i {
            color: var(--text-secondary);
            margin-right: 8px;
        }

        .search-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 16px;
            background: transparent;
            color: var(--text-primary);
        }

        .tabs {
            display: flex;
            background: var(--surface);
            border-bottom: 1px solid var(--surface-light);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .tab.active {
            color: var(--primary-light);
            border-bottom-color: var(--primary-light);
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
            background: var(--surface);
        }

        .conversation-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--surface-light);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }

        .conversation-item:active {
            background: var(--surface-light);
        }

        .conversation-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            background-size: cover;
            background-position: center;
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-primary);
        }

        .verified-badge {
            color: var(--primary-light);
            font-size: 14px;
        }

        .conversation-preview {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .conversation-meta {
            text-align: right;
            margin-left: 8px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .conversation-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .unread-badge {
            background: var(--secondary);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .muted-icon {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .pinned-icon {
            color: var(--text-secondary);
            font-size: 14px;
            transform: rotate(45deg);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        .empty-icon {
            font-size: 60px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* ONLINE USERS LIST */
        .online-users-header { 
            padding: 15px; 
            background: var(--surface); 
            font-weight: 600; 
            color: var(--text-secondary); 
            border-bottom: 1px solid var(--surface-light); 
        }

        .users-list { flex: 1; overflow-y: auto; background: var(--surface); }
        .user-item { 
            padding: 16px; 
            border-bottom: 1px solid var(--surface-light); 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            cursor: pointer; 
            transition: all 0.2s ease;
        }

        .user-item:active { background: var(--surface-light); }
        .user-avatar { 
            width: 48px; 
            height: 48px; 
            border-radius: 50%; 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            font-size: 18px; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            background-size: cover;
            background-position: center;
        }
        .user-info { flex: 1; }
        .user-name { font-weight: 600; font-size: 16px; display: flex; align-items: center; gap: 5px; color: var(--text-primary); }
        .user-status { font-size: 13px; color: var(--text-secondary); display: flex; align-items: center; }
        .online-dot { 
            width: 10px; 
            height: 10px; 
            background: var(--success); 
            border-radius: 50%; 
            margin-right: 5px; 
            display: inline-block; 
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
        }
        .offline-dot { 
            width: 10px; 
            height: 10px; 
            background: var(--text-secondary); 
            border-radius: 50%; 
            margin-right: 5px; 
            display: inline-block; 
        }

        /* CHAT SCREEN */
        .chat-header { 
            background: var(--primary); 
            color: white; 
            padding: 16px; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .back-button { 
            background: none; 
            border: none; 
            color: white; 
            font-size: 20px; 
            cursor: pointer; 
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .back-button:active {
            background: rgba(255, 255, 255, 0.1);
        }
        .chat-info { flex: 1; }
        .chat-name { font-weight: 600; font-size: 17px; display: flex; align-items: center; gap: 5px; }
        .chat-status { 
            font-size: 13px; 
            opacity: 0.9; 
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .messages-container { 
            flex: 1; 
            padding: 16px; 
            overflow-y: auto; 
            background: var(--background); 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }

        .message { 
            max-width: 80%; 
            padding: 12px 16px; 
            border-radius: 12px; 
            animation: messageSlide 0.3s ease-out; 
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        @keyframes messageSlide { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .my-message { 
            background: var(--primary-dark); 
            align-self: flex-end; 
            border-bottom-right-radius: 4px; 
            color: white;
        }

        .their-message { 
            background: var(--surface-light); 
            align-self: flex-start; 
            border-bottom-left-radius: 4px; 
            color: var(--text-primary);
        }

        .message-sender { 
            font-weight: 600; 
            font-size: 14px; 
            color: var(--primary-light); 
            margin-bottom: 4px; 
        }

        .message-text { font-size: 16px; line-height: 1.4; }
        .message-time { 
            font-size: 11px; 
            color: var(--text-secondary); 
            text-align: right; 
            margin-top: 4px; 
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
        }

        .message-status {
            font-size: 11px;
        }
        .message-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .message:hover .message-actions {
            opacity: 1;
        }
        .message-action {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .system-message { 
            text-align: center; 
            color: var(--text-secondary); 
            font-size: 13px; 
            margin: 8px 0; 
            font-style: italic; 
        }

        .message-input-container { 
            padding: 12px 16px; 
            background: var(--surface); 
            border-top: 1px solid var(--surface-light); 
            display: flex; 
            gap: 8px; 
            align-items: center; 
        }

        .message-input { 
            flex: 1; 
            padding: 12px 16px; 
            border: none; 
            border-radius: 22px; 
            font-size: 16px; 
            background: var(--surface-light); 
            color: var(--text-primary);
            outline: none; 
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .input-button { 
            background: transparent; 
            color: var(--primary-light); 
            border: none; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            font-size: 18px; 
            transition: all 0.2s ease;
        }

        .input-button:active {
            background: rgba(106, 17, 203, 0.1);
        }

        .send-button { 
            background: var(--primary); 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            font-size: 18px; 
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .send-button:active {
            transform: scale(0.95);
            background: var(--primary-dark);
        }

        /* Floating action button */
        .floating-button {
            position: fixed;
            bottom: 70px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .floating-button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* Bottom navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            display: flex;
            padding: 8px 0;
            border-top: 1px solid var(--surface-light);
            z-index: 100;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
        }
        
        .nav-item.active {
            color: var(--primary-light);
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        /* Loading indicator */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Last seen indicator */
        .last-seen {
            font-size: 12px;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Typing indicator */
        .typing-indicator {
            background: var(--surface-light);
            padding: 8px 12px;
            border-radius: 12px;
            align-self: flex-start;
            margin-bottom: 8px;
            display: none;
            font-style: italic;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .typing-dots {
            display: inline-flex;
            align-items: center;
        }
        
        .typing-dot {
            width: 4px;
            height: 4px;
            background: var(--text-secondary);
            border-radius: 50%;
            margin: 0 1px;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        /* SETTINGS SCREEN */
        .settings-screen {
            background: var(--surface);
            flex: 1;
            overflow-y: auto;
        }

        .settings-header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
            font-weight: 700;
            font-size: 20px;
            position: relative;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .settings-back-button {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }

        .settings-content {
            padding: 20px;
        }

        .profile-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 36px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            margin-bottom: 15px;
            background-size: cover;
            background-position: center;
            position: relative;
            cursor: pointer;
        }

        .profile-avatar-edit {
            position: absolute;
            bottom: 0;
            right: 0;
            background: var(--primary);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .profile-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .profile-username {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--surface-light);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item-info {
            flex: 1;
        }

        .settings-item-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .settings-item-desc {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--text-secondary);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .select-dropdown {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--surface-light);
            background: var(--surface-light);
            color: var(--text-primary);
            font-size: 14px;
        }

        .logout-button {
            width: 100%;
            padding: 15px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }

        /* Avatar upload modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            color: var(--text-primary);
        }

        .avatar-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .avatar-option {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
            cursor: pointer;
            background-size: cover;
            background-position: center;
        }

        .avatar-option.selected {
            outline: 3px solid var(--primary-light);
            outline-offset: 2px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-button.primary {
            background: var(--primary);
            color: white;
        }

        .modal-button.secondary {
            background: var(--surface-light);
            color: var(--text-primary);
        }

        /* Media message styles */
        .media-message {
            padding: 8px;
            border-radius: 12px;
            overflow: hidden;
            max-width: 300px;
        }

        .media-container {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
        }

        .media-preview {
            width: 100%;
            border-radius: 8px;
            display: block;
        }

        .video-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .media-caption {
            padding: 8px 0;
            font-size: 14px;
            line-height: 1.4;
            color: var(--text-primary);
        }

        .media-download {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            margin-top: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Audio player */
        .audio-player {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--surface-light);
            border-radius: 20px;
            margin: 5px 0;
        }

        .audio-play-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .audio-progress {
            flex: 1;
            height: 4px;
            background: var(--text-secondary);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }

        .audio-progress-filled {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            width: 0%;
        }

        .audio-duration {
            font-size: 12px;
            color: var(--text-secondary);
            min-width: 40px;
            text-align: right;
        }

        /* Document message */
        .document-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--surface-light);
            border-radius: 12px;
            margin: 5px 0;
        }

        .document-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .document-info {
            flex: 1;
            min-width: 0;
        }

        .document-name {
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary);
        }

        .document-size {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .document-download {
            color: var(--primary-light);
            font-size: 18px;
            cursor: pointer;
        }

        /* YouTube downloader styles */
        .youtube-downloader {
            background: var(--surface-light);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .youtube-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .youtube-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--surface);
            border-radius: 8px;
            font-size: 14px;
            background: var(--surface);
            color: var(--text-primary);
        }

        .youtube-fetch-button {
            padding: 12px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .youtube-results {
            display: none;
        }

        .youtube-thumbnail {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .youtube-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .youtube-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .youtube-option {
            padding: 10px;
            background: var(--surface);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .youtube-option:active {
            background: var(--surface-light);
        }

        .youtube-option-quality {
            font-weight: 600;
            color: var(--primary-light);
            margin-bottom: 5px;
        }

        .youtube-option-size {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .youtube-downloading {
            text-align: center;
            padding: 15px;
            display: none;
        }

        .youtube-download-progress {
            width: 100%;
            height: 6px;
            background: var(--surface);
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }

        .youtube-download-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .youtube-download-status {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .youtube-error {
            color: var(--error);
            text-align: center;
            padding: 10px;
            display: none;
        }

        /* YouTube icon in message input */
        .youtube-button {
            background: transparent;
            color: var(--primary-light);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s ease;
        }

        .youtube-button:active {
            background: rgba(106, 17, 203, 0.1);
        }

        /* YouTube download message */
        .youtube-message {
            padding: 12px;
            background: var(--surface-light);
            border-radius: 12px;
            margin: 5px 0;
        }

        .youtube-message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .youtube-message-icon {
            color: #ff0000;
            font-size: 20px;
        }

        .youtube-message-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .youtube-message-url {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            word-break: break-all;
        }

        .youtube-message-actions {
            display: flex;
            gap: 10px;
        }

        .youtube-message-button {
            padding: 8px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        /* Media attachment panel */
        .media-attachment-panel {
            position: absolute;
            bottom: 70px;
            left: 0;
            right: 0;
            background: var(--surface);
            border-top: 1px solid var(--surface-light);
            padding: 15px;
            display: none;
            flex-direction: column;
            gap: 15px;
            z-index: 200;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
        }

        .attachment-options {
            display: flex;
            justify-content: space-around;
        }

        .attachment-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border-radius: 12px;
            background: var(--surface-light);
            min-width: 80px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .attachment-option:active {
            background: var(--surface);
        }

        .attachment-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .attachment-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
        }

        /* File upload button */
        .file-input {
            display: none;
        }

        /* Progress bar */
        .upload-progress {
            width: 100%;
            height: 4px;
            background: var(--surface);
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Avatar upload options */
        .avatar-upload-option {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            border-radius: 8px;
            background: var(--surface-light);
            margin-bottom: 10px;
            cursor: pointer;
        }

        .avatar-upload-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .avatar-upload-text {
            flex: 1;
        }

        .avatar-upload-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .avatar-upload-desc {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Media grid in modal */
        .media-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .media-grid-item {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .media-grid-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-grid-selected {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            display: none;
        }

        .media-grid-item.selected .media-grid-selected {
            display: flex;
        }

        .media-grid-item.selected::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px solid var(--primary);
            border-radius: 8px;
        }

        /* Media modal */
        .media-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .media-modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }

        .media-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            z-index: 1001;
        }

        .media-modal-img {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 8px;
        }

        .media-modal-video {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 8px;
        }

        /* Responsive */
        @media (max-width: 340px) {
            .message { max-width: 75%; }
            .auth-box { max-width: 280px; }
        }

        /* Gram X Music Section */
        .music-section {
            background: var(--surface);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .music-section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .music-section-title i {
            color: var(--primary-light);
        }

        .music-search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .music-search-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--surface-light);
            border-radius: 8px;
            font-size: 14px;
            background: var(--surface-light);
            color: var(--text-primary);
        }

        .music-search-button {
            padding: 12px 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .music-results {
            display: none;
        }

        .music-result-item {
            padding: 10px;
            border-radius: 8px;
            background: var(--surface-light);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .music-thumbnail {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
        }

        .music-info {
            flex: 1;
        }

        .music-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .music-artist {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .music-download-button {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
        }

        .music-downloading {
            text-align: center;
            padding: 15px;
            display: none;
        }

        .music-download-progress {
            width: 100%;
            height: 6px;
            background: var(--surface);
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }

        .music-download-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .music-download-status {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .music-error {
            color: var(--error);
            text-align: center;
            padding: 10px;
            display: none;
        }

        /* Camera modal for taking photos */
        .camera-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .camera-content {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .camera-preview {
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-capture {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin: 0 auto;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .camera-capture:active {
            transform: scale(0.95);
            background: var(--primary-dark);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="screen active">
        <div class="auth-container">
            <div class="auth-box">
                <h1 class="auth-title">gramX</h1>
                <div class="error-message" id="login-error"></div>
                <input type="text" id="login-username" class="auth-input" placeholder="Username">
                <input type="password" id="login-password" class="auth-input" placeholder="Password">
                <button class="auth-button" onclick="login()">Login</button>
                <div class="auth-switch">
                    Don't have an account? <a href="#" onclick="showScreen('register-screen')">Register</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Screen -->
    <div id="register-screen" class="screen">
        <div class="auth-container">
            <div class="auth-box">
                <h1 class="auth-title">Create Account</h1>
                <div class="error-message" id="register-error"></div>
                <input type="text" id="register-username" class="auth-input" placeholder="Choose username">
                <input type="password" id="register-password" class="auth-input" placeholder="Choose password">
                <button class="auth-button" onclick="register()">Create Account</button>
                <div class="auth-switch">
                    Already have an account? <a href="#" onclick="showScreen('login-screen')">Login</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat List Screen -->
    <div id="chat-list-screen" class="screen">
        <div class="chat-list-header">
            gramX
            <div class="header-buttons">
                <button class="header-button" onclick="toggleSearch()">
                    <i class="fas fa-search"></i>
                </button>
                <button class="header-button" onclick="showSettings()">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
        
        <div class="search-container" id="search-container" style="display: none;">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" class="search-input" placeholder="Search" id="search-input">
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('conversations')">Chats</div>
            <div class="tab" onclick="showTab('online')">Online</div>
            <div class="tab" onclick="showTab('all')">All Users</div>
        </div>

        <!-- Conversations Tab -->
        <div id="conversations-tab" class="conversations-list">
            <div class="empty-state" id="no-conversations">
                <div class="empty-icon">💬</div>
                No conversations yet<br>
                <small>Start a chat with someone!</small>
            </div>
            <!-- Conversations will be listed here -->
        </div>

        <!-- Online Users Tab -->
        <div id="online-tab" class="users-list" style="display: none;">
            <div class="empty-state" id="no-online-users">
                <div class="empty-icon">🌐</div>
                No other users online
            </div>
            <!-- Online users will be listed here -->
        </div>

        <!-- All Users Tab -->
        <div id="all-tab" class="users-list" style="display: none;">
            <div class="empty-state" id="no-all-users">
                <div class="empty-icon">👥</div>
                No other users available
            </div>
            <!-- All users will be listed here -->
        </div>
        
        <!-- Floating action button -->
        <div class="floating-button" onclick="showAllUsers()">
            <i class="fas fa-edit"></i>
        </div>
        
        <!-- Bottom navigation -->
        <div class="bottom-nav">
            <div class="nav-item active">
                <div class="nav-icon"><i class="fas fa-comment"></i></div>
                <div>Chats</div>
            </div>
            <div class="nav-item">
                <div class="nav-icon"><i class="fas fa-users"></i></div>
                <div>Contacts</div>
            </div>
            <div class="nav-item">
                <div class="nav-icon"><i class="fas fa-cog"></i></div>
                <div>Settings</div>
            </div>
        </div>
    </div>

    <!-- Private Chat Screen -->
    <div id="private-chat-screen" class="screen">
        <div class="chat-header">
            <button class="back-button" onclick="backToChatList()">←</button>
            <div class="chat-info">
                <div class="chat-name" id="chat-target-name">
                    User
                    <i class="fas fa-check-circle verified-badge"></i>
                </div>
                <div class="chat-status" id="chat-target-status">
                    <span class="online-dot" id="status-dot"></span>
                    <span id="status-text">online</span>
                </div>
            </div>
            <button class="header-button" onclick="showChatOptions()">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        </div>

        <div class="messages-container" id="private-messages-container">
            <!-- Private messages will appear here -->
            <div class="typing-indicator" id="typing-indicator">
                <span id="typing-user"></span> is typing
                <span class="typing-dots">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </span>
            </div>
        </div>

        <div class="message-input-container">
            <button class="input-button" onclick="toggleMediaPanel()">
                <i class="fas fa-paperclip"></i>
            </button>
            <button class="youtube-button" onclick="toggleYouTubePanel()">
                <i class="fab fa-youtube"></i>
            </button>
            <input type="text" id="private-message-input" class="message-input" placeholder="Message" 
                onkeypress="handlePrivateKeyPress(event)"
                oninput="handleTyping()">
            <button class="input-button">
                <i class="fas fa-smile"></i>
            </button>
            <button class="send-button" onclick="sendPrivateMessage()" id="send-button">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Settings Screen -->
    <div id="settings-screen" class="screen">
        <div class="settings-header">
            <button class="settings-back-button" onclick="backToChatList()">←</button>
            Settings
        </div>
        
        <div class="settings-content">
            <div class="profile-section">
                <div class="profile-avatar" id="profile-avatar" onclick="openAvatarModal()">
                    <div class="profile-avatar-edit">
                        <i class="fas fa-camera"></i>
                    </div>
                </div>
                <div class="profile-name" id="profile-name">User Name</div>
                <div class="profile-username" id="profile-username">@username</div>
            </div>
            
            <!-- Gram X Music Downloader Section -->
            <div class="music-section">
                <div class="music-section-title">
                    <i class="fas fa-music"></i> Gram X Music Downloader
                </div>
                
                <div class="music-search-container">
                    <input type="text" class="music-search-input" id="music-search-input" placeholder="Search for songs...">
                    <button class="music-search-button" onclick="searchMusic()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                
                <div class="music-results" id="music-results">
                    <!-- Music results will appear here -->
                </div>
                
                <div class="music-downloading" id="music-downloading">
                    <div class="loading"></div>
                    <div class="music-download-progress">
                        <div class="music-download-bar" id="music-download-bar"></div>
                    </div>
                    <div class="music-download-status" id="music-download-status">Preparing download...</div>
                </div>
                
                <div class="music-error" id="music-error"></div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">Appearance</div>
                
                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-title">Theme</div>
                        <div class="settings-item-desc">Change the appearance of the app</div>
                    </div>
                    <select class="select-dropdown" id="theme-selector" onchange="changeTheme()">
                        <option value="light">Light</option>
                        <option value="dark" selected>Dark</option>
                        <option value="auto">Auto (System)</option>
                    </select>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">Notifications</div>
                
                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-title">Message Notifications</div>
                        <div class="settings-item-desc">Receive notifications for new messages</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="notifications-toggle" checked onchange="toggleNotifications()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-title">Sound</div>
                        <div class="settings-item-desc">Play sounds for new messages</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="sound-toggle" checked onchange="toggleSound()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">Privacy</div>
                
                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-title">Last Seen</div>
                        <div class="settings-item-desc">Who can see your last seen time</div>
                    </div>
                    <select class="select-dropdown" id="last-seen-selector" onchange="changeLastSeenPrivacy()">
                        <option value="everyone">Everyone</option>
                        <option value="contacts">My Contacts</option>
                        <option value="nobody">Nobody</option>
                    </select>
                </div>
                
                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-title">Profile Photo</div>
                        <div class="settings-item-desc">Who can see your profile photo</div>
                    </div>
                    <select class="select-dropdown" id="profile-photo-selector" onchange="changeProfilePhotoPrivacy()">
                        <option value="everyone">Everyone</option>
                        <option value="contacts">My Contacts</option>
                        <option value="nobody">Nobody</option>
                    </select>
                </div>
                
                <div class="settings-item">
                    <div class="settings-item-info">
                        <div class="settings-item-title">Read Receipts</div>
                        <div class="settings-item-desc">Send read receipts for your messages</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="read-receipts-toggle" checked onchange="toggleReadReceipts()">
                        <span class="toggle-slider"></span>
                    </label>
            </div>
            
            <button class="logout-button" onclick="logout()">Log Out</button>
        </div>
    </div>

    <!-- Media Attachment Panel -->
    <div class="media-attachment-panel" id="media-attachment-panel">
        <div class="attachment-options">
            <div class="attachment-option" onclick="openGallery('image')">
                <div class="attachment-icon">
                    <i class="fas fa-image"></i>
                </div>
                <div class="attachment-label">Photos</div>
            </div>
            <div class="attachment-option" onclick="openGallery('video')">
                <div class="attachment-icon">
                    <i class="fas fa-video"></i>
                </div>
                <div class="attachment-label">Videos</div>
            </div>
            <div class="attachment-option" onclick="openFilePicker('audio')">
                <div class="attachment-icon">
                    <i class="fas fa-music"></i>
                </div>
                <div class="attachment-label">Audio</div>
            </div>
            <div class="attachment-option" onclick="openFilePicker('document')">
                <div class="attachment-icon">
                    <i class="fas fa-file"></i>
                </div>
                <div class="attachment-label">Document</div>
            </div>
        </div>
    </div>

    <!-- YouTube Download Panel -->
    <div class="media-attachment-panel" id="youtube-panel">
        <div class="youtube-downloader">
            <div class="youtube-input-container">
                <input type="text" class="youtube-input" id="youtube-url" placeholder="Paste YouTube URL">
                <button class="youtube-fetch-button" onclick="fetchYouTubeInfo()">
                    <i class="fas fa-search"></i>
                </button>
            </div>

            <div class="youtube-results" id="youtube-results">
                <img src="" class="youtube-thumbnail" id="youtube-thumbnail">
                <div class="youtube-title" id="youtube-title"></div>
                
                <div class="youtube-options" id="youtube-options">
                    <!-- Options will be populated here -->
                </div>
            </div>

            <div class="youtube-downloading" id="youtube-downloading">
                <div class="loading"></div>
                <div class="youtube-download-progress">
                    <div class="youtube-download-bar" id="youtube-download-bar"></div>
                </div>
                <div class="youtube-download-status" id="youtube-download-status">Preparing download...</div>
            </div>

            <div class="youtube-error" id="youtube-error"></div>
        </div>
    </div>

    <!-- Hidden file input for media uploads -->
    <input type="file" id="image-input" class="file-input" accept="image/*" multiple>
    <input type="file" id="video-input" class="file-input" accept="video/*">
    <input type="file" id="audio-input" class="file-input" accept="audio/*">
    <input type="file" id="document-input" class="file-input" accept="*">
    <input type="file" id="avatar-input" class="file-input" accept="image/*">

    <!-- Media modal for viewing images/videos -->
    <div class="media-modal" id="media-modal">
        <div class="media-modal-content">
            <div class="media-modal-close" onclick="closeMediaModal()">
                <i class="fas fa-times"></i>
            </div>
            <img class="media-modal-img" id="media-modal-img" src="" alt="">
            <video class="media-modal-video" id="media-modal-video" controls></video>
        </div>
    </div>

    <!-- Avatar Selection Modal -->
    <div class="modal-overlay" id="avatar-modal">
        <div class="modal-content">
            <div class="modal-title">Choose Profile Picture</div>
            
            <div class="avatar-upload-option" onclick="openAvatarGallery()">
                <div class="avatar-upload-icon">
                    <i class="fas fa-image"></i>
                </div>
                <div class="avatar-upload-text">
                    <div class="avatar-upload-title">Choose from Gallery</div>
                    <div class="avatar-upload-desc">Select a photo from your device</div>
                </div>
            </div>
            
            <div class="avatar-upload-option" onclick="openCamera()">
                <div class="avatar-upload-icon">
                    <i class="fas fa-camera"></i>
                </div>
                <div class="avatar-upload-text">
                    <div class="avatar-upload-title">Take Photo</div>
                    <div class="avatar-upload-desc">Use your camera to take a picture</div>
                </div>
            </div>
            
            <div class="avatar-options">
                <div class="avatar-option" style="background-color: #6a11cb;" onclick="selectAvatar('default1')">U</div>
                <div class="avatar-option" style="background-color: #4CAF50;" onclick="selectAvatar('default2')">U</div>
                <div class="avatar-option" style="background-color: #FF9800;" onclick="selectAvatar('default3')">U</div>
                <div class="avatar-option" style="background-color: #9C27B0;" onclick="selectAvatar('default4')">U</div>
                <div class="avatar-option" style="background-color: #F44336;" onclick="selectAvatar('default5')">U</div>
                <div class="avatar-option" style="background-color: #00BCD4;" onclick="selectAvatar('default6')">U</div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeAvatarModal()">Cancel</button>
                <button class="modal-button primary" onclick="saveAvatar()">Save</button>
            </div>
        </div>
    </div>

    <!-- Gallery modal for avatar selection -->
    <div class="modal-overlay" id="avatar-gallery-modal">
        <div class="modal-content">
            <div class="modal-title">Select Profile Picture</div>
            
            <div class="media-grid" id="avatar-gallery-grid">
                <!-- Gallery items will be populated here -->
            </div>
            
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeAvatarGallery()">Cancel</button>
                <button class="modal-button primary" onclick="confirmAvatarSelection()">Select</button>
            </div>
        </div>
    </div>

    <!-- Camera modal for taking photos -->
    <div class="camera-modal" id="camera-modal">
        <div class="camera-content">
            <div class="modal-title">Take a Photo</div>
            
            <div class="camera-preview" id="camera-preview">
                <video class="camera-video" id="camera-video" autoplay></video>
                <canvas id="camera-canvas" style="display: none;"></canvas>
            </div>
            
            <div class="camera-capture" onclick="capturePhoto()">
                <i class="fas fa-camera"></i>
            </div>
            
            <div class="modal-buttons" style="margin-top: 15px;">
                <button class="modal-button secondary" onclick="closeCamera()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // App state
        let socket = null;
        let currentUser = null;
        let currentTargetUser = null;
        let onlineUsers = [];
        let allUsers = [];
        let userConversations = [];
        let pendingMessages = {};
        let typingTimeout = null;
        let currentConversationId = null;
        let userSettings = {};
        let selectedAvatar = null;
        let mediaFiles = [];
        let selectedMedia = null;
        let avatarGalleryFiles = [];
        let selectedAvatarFile = null;
        let currentYouTubeUrl = '';
        let youtubeDownloadInProgress = false;
        let musicDownloadInProgress = false;
        let cameraStream = null;

        // Initialize user settings with defaults
        const defaultSettings = {
            theme: 'dark',
            notifications: true,
            sound: true,
            privacy: {
                lastSeen: 'everyone',
                profilePhoto: 'everyone',
                readReceipts: true
            },
            avatar: 'default1'
        };

        // UI Functions
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 3000);
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            if (tabName === 'conversations') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
            } else if (tabName === 'online') {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
            } else {
                document.querySelector('.tab:nth-child(3)').classList.add('active');
            }
            
            document.getElementById('conversations-tab').style.display = tabName === 'conversations' ? 'block' : 'none';
            document.getElementById('online-tab').style.display = tabName === 'online' ? 'block' : 'none';
            document.getElementById('all-tab').style.display = tabName === 'all' ? 'block' : 'none';
        }

        function toggleSearch() {
            const searchContainer = document.getElementById('search-container');
            const isVisible = searchContainer.style.display === 'block';
            searchContainer.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                document.getElementById('search-input').focus();
            }
        }

        function showSettings() {
            loadUserSettings();
            showScreen('settings-screen');
        }

        function showChatOptions() {
            alert('Chat options menu would open here');
        }

        function showAllUsers() {
            showTab('all');
        }

        // Settings functions
        function loadUserSettings() {
            // Load settings from localStorage or use defaults
            const savedSettings = localStorage.getItem(`gramx_settings_${currentUser}`);
            userSettings = savedSettings ? JSON.parse(savedSettings) : {...defaultSettings};
            
            // Apply settings to UI
            document.getElementById('theme-selector').value = userSettings.theme;
            document.getElementById('notifications-toggle').checked = userSettings.notifications;
            document.getElementById('sound-toggle').checked = userSettings.sound;
            document.getElementById('last-seen-selector').value = userSettings.privacy.lastSeen;
            document.getElementById('profile-photo-selector').value = userSettings.privacy.profilePhoto;
            document.getElementById('read-receipts-toggle').checked = userSettings.privacy.readReceipts;
            
            // Apply theme
            applyTheme(userSettings.theme);
            
            // Update profile info
            document.getElementById('profile-name').textContent = currentUser;
            document.getElementById('profile-username').textContent = `@${currentUser}`;
            
            // Set avatar
            setAvatar(userSettings.avatar);
        }

        function saveUserSettings() {
            localStorage.setItem(`gramx_settings_${currentUser}`, JSON.stringify(userSettings));
            
            // Send to server if connected
            if (socket) {
                socket.emit('update-user-settings', userSettings);
            }
        }

        function applyTheme(theme) {
            if (theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
            }
        }

        function changeTheme() {
            userSettings.theme = document.getElementById('theme-selector').value;
            applyTheme(userSettings.theme);
            saveUserSettings();
        }

        function toggleNotifications() {
            userSettings.notifications = document.getElementById('notifications-toggle').checked;
            saveUserSettings();
        }

        function toggleSound() {
            userSettings.sound = document.getElementById('sound-toggle').checked;
            saveUserSettings();
        }

        function changeLastSeenPrivacy() {
            userSettings.privacy.lastSeen = document.getElementById('last-seen-selector').value;
            saveUserSettings();
        }

        function changeProfilePhotoPrivacy() {
            userSettings.privacy.profilePhoto = document.getElementById('profile-photo-selector').value;
            saveUserSettings();
        }

        function toggleReadReceipts() {
            userSettings.privacy.readReceipts = document.getElementById('read-receipts-toggle').checked;
            saveUserSettings();
        }

        function openAvatarModal() {
            selectedAvatar = userSettings.avatar;
            document.getElementById('avatar-modal').style.display = 'flex';
            
            // Highlight current selection
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            const currentOption = document.querySelector(`.avatar-option[onclick="selectAvatar('${userSettings.avatar}')"]`);
            if (currentOption) {
                currentOption.classList.add('selected');
            }
        }

        function closeAvatarModal() {
            document.getElementById('avatar-modal').style.display = 'none';
        }

        function selectAvatar(avatarId) {
            selectedAvatar = avatarId;
            
            // Update selection UI
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            const selectedOption = document.querySelector(`.avatar-option[onclick="selectAvatar('${avatarId}')"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
        }

        function saveAvatar() {
            userSettings.avatar = selectedAvatar;
            setAvatar(selectedAvatar);
            saveUserSettings();
            closeAvatarModal();
        }

        function setAvatar(avatarId) {
            const avatarElement = document.getElementById('profile-avatar');
            const color = getAvatarColor(avatarId);
            const letter = currentUser ? currentUser.charAt(0).toUpperCase() : 'U';
            
            avatarElement.style.background = color;
            avatarElement.textContent = letter;
            
            // Also update avatar in chat list if needed
            updateUserAvatarInUI(currentUser, avatarId);
        }

        function getAvatarColor(avatarId) {
            const colors = {
                'default1': 'linear-gradient(135deg, #6a11cb 0%, #4a08a3 100%)',
                'default2': 'linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%)',
                'default3': 'linear-gradient(135deg, #FF9800 0%, #EF6C00 100%)',
                'default4': 'linear-gradient(135deg, #9C27B0 0%, #6A1B9A 100%)',
                'default5': 'linear-gradient(135deg, #F44336 0%, #C62828 100%)',
                'default6': 'linear-gradient(135deg, #00BCD4 0%, #00838F 100%)'
            };
            
            return colors[avatarId] || colors['default1'];
        }

        function updateUserAvatarInUI(username, avatarId) {
            // Update in conversations list
            const conversationItems = document.querySelectorAll('.conversation-item');
            conversationItems.forEach(item => {
                const nameElement = item.querySelector('.conversation-name');
                if (nameElement && nameElement.textContent.includes(username)) {
                    const avatarElement = item.querySelector('.conversation-avatar');
                    if (avatarElement) {
                        avatarElement.style.background = getAvatarColor(avatarId);
                        avatarElement.textContent = username.charAt(0).toUpperCase();
                    }
                }
            });
            
            // Update in users list
            const userItems = document.querySelectorAll('.user-item');
            userItems.forEach(item => {
                const nameElement = item.querySelector('.user-name');
                if (nameElement && nameElement.textContent.includes(username)) {
                    const avatarElement = item.querySelector('.user-avatar');
                    if (avatarElement) {
                        avatarElement.style.background = getAvatarColor(avatarId);
                        avatarElement.textContent = username.charAt(0).toUpperCase();
                    }
                }
            });
        }

        // Authentication functions
        async function register() {
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            
            if (!username || !password) {
                showError('register-error', 'Please enter both username and password');
                return;
            }
            
            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showError('register-error', 'Registration successful! Please login.');
                    setTimeout(() => {
                        showScreen('login-screen');
                    }, 1500);
                } else {
                    showError('register-error', result.error);
                }
            } catch (error) {
                showError('register-error', 'Network error. Please try again.');
            }
        }

        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            if (!username || !password) {
                showError('login-error', 'Please enter both username and password');
                return;
            }
            
            try {
                const button = document.querySelector('#login-screen .auth-button');
                const originalText = button.textContent;
                button.innerHTML = '<div class="loading"></div>';
                button.disabled = true;

                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                button.textContent = originalText;
                button.disabled = false;
                
                if (result.success) {
                    currentUser = username;
                    localStorage.setItem('gramx_current_user', username);
                    initializeSocket();
                    showScreen('chat-list-screen');
                } else {
                    showError('login-error', result.error);
                }
            } catch (error) {
                showError('login-error', 'Network error. Please try again.');
                const button = document.querySelector('#login-screen .auth-button');
                button.textContent = 'Login';
                button.disabled = false;
            }
        }

        function logout() {
            if (socket) {
                socket.disconnect();
            }
            currentUser = null;
            localStorage.removeItem('gramx_current_user');
            showScreen('login-screen');
        }

        // Socket initialization and event handling
        function initializeSocket() {
            // Simulate socket connection for demo purposes
            console.log('Simulating socket connection');
            
            // Simulate online users
            setTimeout(() => {
                onlineUsers = ['alice', 'bob', 'charlie'];
                updateOnlineUsersList();
                
                // Simulate conversations
                userConversations = [
                    {
                        partner: 'alice',
                        lastMessage: { text: 'Hey there!', sender: 'alice', timestamp: new Date() },
                        unreadCount: 0
                    },
                    {
                        partner: 'bob',
                        lastMessage: { text: 'How are you?', sender: 'bob', timestamp: new Date() },
                        unreadCount: 3
                    }
                ];
                updateConversationsList();
            }, 1000);
        }

        // Update UI functions
        function updateConversationsList() {
            const container = document.getElementById('conversations-tab');
            const emptyState = document.getElementById('no-conversations');
            
            if (userConversations.length === 0) {
                emptyState.style.display = 'flex';
                container.innerHTML = '';
                return;
            }
            
            emptyState.style.display = 'none';
            container.innerHTML = '';
            
            userConversations.forEach(conv => {
                const convElement = document.createElement('div');
                convElement.className = 'conversation-item';
                convElement.onclick = () => startPrivateChat(conv.partner);
                
                const lastMessageTime = conv.lastMessage ? new Date(conv.lastMessage.timestamp).toLocaleTimeString([], { 
                    hour: '2-digit', minute: '2-digit' 
                }) : '';
                
                const lastMessageText = conv.lastMessage ? 
                    (conv.lastMessage.sender === currentUser ? 'You: ' : '') + conv.lastMessage.text : 
                    'No messages yet';
                
                const isOnline = onlineUsers.includes(conv.partner);
                
                // Get avatar color from settings if available
                let avatarColor = 'linear-gradient(135deg, #6a11cb 0%, #4a08a3 100%)';
                const partnerSettings = localStorage.getItem(`gramx_settings_${conv.partner}`);
                if (partnerSettings) {
                    try {
                        const settings = JSON.parse(partnerSettings);
                        avatarColor = getAvatarColor(settings.avatar);
                    } catch (e) {
                        console.error('Error parsing partner settings:', e);
                    }
                }
                
                convElement.innerHTML = `
                    <div class="conversation-avatar" style="background: ${avatarColor}">${conv.partner.charAt(0).toUpperCase()}</div>
                    <div class="conversation-info">
                        <div class="conversation-name">
                            ${conv.partner}
                        </div>
                        <div class="conversation-preview">
                            ${lastMessageText}
                        </div>
                    </div>
                    <div class="conversation-meta">
                        <div class="conversation-time">${lastMessageTime}</div>
                        ${isOnline ? '<span class="online-dot"></span>' : ''}
                        ${conv.unreadCount > 0 ? `<div class="unread-badge">${conv.unreadCount}</div>` : ''}
                    </div>
                `;
                
                container.appendChild(convElement);
            });
        }

        function updateOnlineUsersList() {
            const container = document.getElementById('online-tab');
            const emptyState = document.getElementById('no-online-users');
            
            if (onlineUsers.length === 0) {
                emptyState.style.display = 'flex';
                container.innerHTML = '';
                return;
            }
            
            emptyState.style.display = 'none';
            container.innerHTML = '';
            
            onlineUsers.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'user-item';
                userElement.onclick = () => startPrivateChat(user);
                
                // Get avatar color from settings if available
                let avatarColor = 'linear-gradient(135deg, #6a11cb 0%, #4a08a3 100%)';
                const userSettings = localStorage.getItem(`gramx_settings_${user}`);
                if (userSettings) {
                    try {
                        const settings = JSON.parse(userSettings);
                        avatarColor = getAvatarColor(settings.avatar);
                    } catch (e) {
                        console.error('Error parsing user settings:', e);
                    }
                }
                
                userElement.innerHTML = `
                    <div class="user-avatar" style="background: ${avatarColor}">${user.charAt(0).toUpperCase()}</div>
                    <div class="user-info">
                        <div class="user-name">${user}</div>
                        <div class="user-status"><span class="online-dot"></span>Online</div>
                    </div>
                `;
                
                container.appendChild(userElement);
            });
        }

        async function loadAllUsers() {
            const container = document.getElementById('all-tab');
            const emptyState = document.getElementById('no-all-users');
            
            try {
                // In a real app, you would fetch this from the server
                // For now, we'll combine online users with some offline users
                const offlineUsers = ['david', 'emma', 'frank'].filter(user => 
                    user !== currentUser && !onlineUsers.includes(user)
                );
                
                const allUsersList = [...onlineUsers, ...offlineUsers];
                
                if (allUsersList.length === 0) {
                    emptyState.style.display = 'flex';
                    container.innerHTML = '';
                    return;
                }
                
                emptyState.style.display = 'none';
                container.innerHTML = '';
                
                allUsersList.forEach(user => {
                    const userElement = document.createElement('div');
                    userElement.className = 'user-item';
                    userElement.onclick = () => startPrivateChat(user);
                    
                    const isOnline = onlineUsers.includes(user);
                    
                    // Get avatar color from settings if available
                    let avatarColor = 'linear-gradient(135deg, #6a11cb 0%, #4a08a3 100%)';
                    const userSettings = localStorage.getItem(`gramx_settings_${user}`);
                    if (userSettings) {
                        try {
                            const settings = JSON.parse(userSettings);
                            avatarColor = getAvatarColor(settings.avatar);
                        } catch (e) {
                            console.error('Error parsing user settings:', e);
                        }
                    }
                    
                    userElement.innerHTML = `
                        <div class="user-avatar" style="background: ${avatarColor}">${user.charAt(0).toUpperCase()}</div>
                        <div class="user-info">
                            <div class="user-name">${user}</div>
                            <div class="user-status">
                                ${isOnline ? '<span class="online-dot"></span>Online' : '<span class="offline-dot"></span>Offline'}
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(userElement);
                });
            } catch (error) {
                console.error('Error loading all users:', error);
                emptyState.style.display = 'flex';
                emptyState.innerHTML = `
                    <div class="empty-icon">❌</div>
                    Failed to load users
                `;
            }
        }

        // Chat functions
        function startPrivateChat(targetUser) {
            if (!currentUser) return;
            
            currentTargetUser = targetUser;
            document.getElementById('chat-target-name').textContent = targetUser;
            
            // Check if target is online
            const isOnline = onlineUsers.includes(targetUser);
            document.getElementById('status-text').textContent = isOnline ? 'online' : 'offline';
            document.getElementById('status-dot').style.background = isOnline ? '#4CAF50' : '#666';
            
            // Show the chat screen
            showScreen('private-chat-screen');
            
            // Clear any existing messages
            document.getElementById('private-messages-container').innerHTML = '';
            
            // Add a welcome message
            addMessageToChat({
                sender: targetUser,
                text: `Hello! This is the beginning of your conversation with ${targetUser}.`,
                timestamp: new Date(),
                read: true,
                delivered: true
            });
        }

        function addMessageToChat(message) {
            const container = document.getElementById('private-messages-container');
            
            // Remove "no messages" system message if it exists
            const systemMessage = container.querySelector('.system-message');
            if (systemMessage && systemMessage.textContent.includes('No messages yet')) {
                systemMessage.remove();
            }
            
            const messageDiv = document.createElement('div');
            
            const isMyMessage = message.sender === currentUser;
            messageDiv.className = `message ${isMyMessage ? 'my-message' : 'their-message'}`;
            
            const time = new Date(message.timestamp).toLocaleTimeString([], { 
                hour: '2-digit', minute: '2-digit' 
            });
            
            let statusHtml = '';
            if (isMyMessage) {
                if (message.read) {
                    statusHtml = '<i class="fas fa-check-double" style="color: #6a11cb;"></i> Read';
                } else if (message.delivered) {
                    statusHtml = '<i class="fas fa-check-double" style="color: #6a11cb;"></i>';
                } else {
                    statusHtml = '<i class="fas fa-check"></i>';
                }
            }
            
            messageDiv.innerHTML = `
                ${!isMyMessage ? `<div class="message-sender">${message.sender}</div>` : ''}
                <div class="message-text">${message.text}</div>
                <div class="message-time">${time} ${statusHtml}</div>
            `;
            
            container.appendChild(messageDiv);
            
            // Make sure typing indicator stays at the bottom
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                container.appendChild(typingIndicator);
            }
            
            container.scrollTop = container.scrollHeight;
        }

        function sendPrivateMessage() {
            const input = document.getElementById('private-message-input');
            const text = input.value.trim();
            
            if (text && currentTargetUser) {
                const messageData = {
                    sender: currentUser,
                    receiver: currentTargetUser,
                    text: text,
                    timestamp: new Date(),
                    read: false,
                    delivered: false
                };
                
                // Add message immediately to UI with "sending" status
                addMessageToChat(messageData);
                
                // Simulate sending message
                setTimeout(() => {
                    // Simulate message delivered
                    messageData.delivered = true;
                    messageData.read = true;
                    
                    // Update message status
                    const messages = document.querySelectorAll('.message');
                    const lastMessage = messages[messages.length - 1];
                    if (lastMessage) {
                        const statusElement = lastMessage.querySelector('.message-status');
                        if (statusElement) {
                            statusElement.innerHTML = '<i class="fas fa-check-double" style="color: #6a11cb;"></i> Read';
                        }
                    }
                    
                    // Simulate response after a delay
                    setTimeout(() => {
                        addMessageToChat({
                            sender: currentTargetUser,
                            text: getRandomResponse(),
                            timestamp: new Date(),
                            read: true,
                            delivered: true
                        });
                    }, 1000 + Math.random() * 2000);
                }, 500);
                
                input.value = '';
            }
        }

        function getRandomResponse() {
            const responses = [
                "Interesting!",
                "I see what you mean.",
                "Tell me more about that.",
                "That's great to hear!",
                "I understand completely.",
                "Thanks for sharing that.",
                "I feel the same way.",
                "That's really cool!",
                "I appreciate your perspective.",
                "Let's discuss this more."
            ];
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function handleTyping() {
            // Simulate typing indicator
            const typingIndicator = document.getElementById('typing-indicator');
            const typingUser = document.getElementById('typing-user');
            
            if (typingIndicator && typingUser) {
                typingUser.textContent = currentUser;
                typingIndicator.style.display = 'block';
                
                // Clear previous timeout
                if (typingTimeout) {
                    clearTimeout(typingTimeout);
                }
                
                // Hide typing indicator after 2 seconds
                typingTimeout = setTimeout(() => {
                    typingIndicator.style.display = 'none';
                }, 2000);
            }
        }

        function handlePrivateKeyPress(event) {
            if (event.key === 'Enter') {
                sendPrivateMessage();
            }
        }

        function backToChatList() {
            showScreen('chat-list-screen');
        }

        // Media attachment functions
        function toggleMediaPanel() {
            const panel = document.getElementById('media-attachment-panel');
            const youtubePanel = document.getElementById('youtube-panel');
            
            // Hide YouTube panel if shown
            if (youtubePanel.style.display === 'flex') {
                youtubePanel.style.display = 'none';
            }
            
            // Toggle media panel
            panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
        }

        function toggleYouTubePanel() {
            const panel = document.getElementById('youtube-panel');
            const mediaPanel = document.getElementById('media-attachment-panel');
            
            // Hide media panel if shown
            if (mediaPanel.style.display === 'flex') {
                mediaPanel.style.display = 'none';
            }
            
            // Toggle YouTube panel
            panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
            
            // Clear previous results when opening
            if (panel.style.display === 'flex') {
                document.getElementById('youtube-url').value = '';
                document.getElementById('youtube-results').style.display = 'none';
                document.getElementById('youtube-downloading').style.display = 'none';
                document.getElementById('youtube-error').style.display = 'none';
            }
        }

        function openGallery(type) {
            const inputId = type === 'image' ? 'image-input' : 'video-input';
            document.getElementById(inputId).click();
        }

        function openFilePicker(type) {
            const inputId = type + '-input';
            document.getElementById(inputId).click();
        }

        // Handle file selection
        function setupFileInputListeners() {
            // Image input
            document.getElementById('image-input').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleMediaSelection(e.target.files, 'image');
                }
            });

            // Video input
            document.getElementById('video-input').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleMediaSelection(e.target.files, 'video');
                }
            });

            // Audio input
            document.getElementById('audio-input').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleMediaSelection(e.target.files, 'audio');
                }
            });

            // Document input
            document.getElementById('document-input').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleMediaSelection(e.target.files, 'document');
                }
            });

            // Avatar input
            document.getElementById('avatar-input').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleAvatarSelection(e.target.files[0]);
                }
            });
        }

        function handleMediaSelection(files, type) {
            // Hide the media panel
            document.getElementById('media-attachment-panel').style.display = 'none';
            
            // For multiple images, send them all
            if (type === 'image' && files.length > 1) {
                for (let i = 0; i < files.length; i++) {
                    sendMediaMessage(files[i], type);
                }
            } else {
                // For single files, send the first one
                sendMediaMessage(files[0], type);
            }
        }

        function sendMediaMessage(file, type) {
            // Create a temporary message while uploading
            const messageData = {
                sender: currentUser,
                receiver: currentTargetUser,
                type: type,
                file: file,
                timestamp: new Date(),
                status: 'uploading'
            };

            // Show uploading state
            addMediaMessageToChat(messageData);

            // Simulate upload progress
            simulateFileUpload(file, type);
        }

        function simulateFileUpload(file, type) {
            // Simulate upload progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 5;
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    
                    // After "upload", show the message as sent
                    const messageElement = document.querySelectorAll('.message');
                    const lastMessage = messageElement[messageElement.length - 1];
                    if (lastMessage) {
                        const progressElement = lastMessage.querySelector('.upload-progress');
                        if (progressElement) {
                            progressElement.style.display = 'none';
                        }
                        
                        const statusElement = lastMessage.querySelector('.message-status');
                        if (statusElement) {
                            statusElement.innerHTML = '<i class="fas fa-check"></i>';
                        }
                    }
                }
            }, 200);
        }

        function addMediaMessageToChat(message) {
            const container = document.getElementById('private-messages-container');
            
            // Remove "no messages" system message if it exists
            const systemMessage = container.querySelector('.system-message');
            if (systemMessage && systemMessage.textContent.includes('No messages yet')) {
                systemMessage.remove();
            }
            
            const messageDiv = document.createElement('div');
            
            const isMyMessage = message.sender === currentUser;
            messageDiv.className = `message ${isMyMessage ? 'my-message' : 'their-message'}`;
            
            let mediaContent = '';
            
            switch (message.type) {
                case 'image':
                    const imageUrl = URL.createObjectURL(message.file);
                    mediaContent = `
                        <div class="media-message">
                            <div class="media-container">
                                <img src="${imageUrl}" class="media-preview" onclick="openMediaModal('${imageUrl}', 'image')">
                                ${message.status === 'uploading' ? '<div class="upload-progress"><div class="progress-bar"></div></div>' : ''}
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'video':
                    const videoUrl = URL.createObjectURL(message.file);
                    mediaContent = `
                        <div class="media-message">
                            <div class="media-container">
                                <video class="media-preview" onclick="openMediaModal('${videoUrl}', 'video')">
                                    <source src="${videoUrl}" type="video/mp4">
                                </video>
                                <div class="video-icon">
                                    <i class="fas fa-play"></i>
                                </div>
                                ${message.status === 'uploading' ? '<div class="upload-progress"><div class="progress-bar"></div></div>' : ''}
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'audio':
                    const audioUrl = URL.createObjectURL(message.file);
                    mediaContent = `
                        <div class="audio-player">
                            <div class="audio-play-button" onclick="playAudio(this, '${audioUrl}')">
                                <i class="fas fa-play"></i>
                            </div>
                            <div class="audio-progress" onclick="seekAudio(this, event)">
                                <div class="audio-progress-filled"></div>
                            </div>
                            <div class="audio-duration">0:00</div>
                        </div>
                        ${message.status === 'uploading' ? '<div class="upload-progress"><div class="progress-bar"></div></div>' : ''}
                    `;
                    break;
                    
                case 'document':
                    mediaContent = `
                        <div class="document-message">
                            <div class="document-icon">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <div class="document-info">
                                <div class="document-name">${message.file.name}</div>
                                <div class="document-size">${formatFileSize(message.file.size)}</div>
                            </div>
                            <div class="document-download" onclick="downloadFile('${URL.createObjectURL(message.file)}', '${message.file.name}')">
                                <i class="fas fa-download"></i>
                            </div>
                        </div>
                        ${message.status === 'uploading' ? '<div class="upload-progress"><div class="progress-bar"></div></div>' : ''}
                    `;
                    break;
            }
            
            const time = new Date(message.timestamp).toLocaleTimeString([], { 
                hour: '2-digit', minute: '2-digit' 
            });
            
            let statusHtml = '';
            if (isMyMessage) {
                if (message.status === 'uploading') {
                    statusHtml = '<i class="fas fa-clock"></i>';
                } else {
                    statusHtml = '<i class="fas fa-check"></i>';
                }
            }
            
            messageDiv.innerHTML = `
                ${!isMyMessage ? `<div class="message-sender">${message.sender}</div>` : ''}
                ${mediaContent}
                <div class="message-time">${time} ${statusHtml}</div>
            `;
            
            container.appendChild(messageDiv);
            
            // Make sure typing indicator stays at the bottom
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                container.appendChild(typingIndicator);
            }
            
            container.scrollTop = container.scrollHeight;
        }

        function openMediaModal(url, type) {
            const modal = document.getElementById('media-modal');
            const img = document.getElementById('media-modal-img');
            const video = document.getElementById('media-modal-video');
            
            if (type === 'image') {
                img.src = url;
                img.style.display = 'block';
                video.style.display = 'none';
            } else {
                video.src = url;
                video.style.display = 'block';
                img.style.display = 'none';
            }
            
            modal.style.display = 'flex';
        }

        function closeMediaModal() {
            const modal = document.getElementById('media-modal');
            const video = document.getElementById('media-modal-video');
            
            // Pause video when closing modal
            video.pause();
            modal.style.display = 'none';
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }

        function downloadFile(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Audio player functions
        function playAudio(button, url) {
            const icon = button.querySelector('i');
            const audioPlayer = button.closest('.audio-player');
            const progress = audioPlayer.querySelector('.audio-progress-filled');
            const duration = audioPlayer.querySelector('.audio-duration');
            
            if (icon.classList.contains('fa-play')) {
                // Play audio
                icon.classList.remove('fa-play');
                icon.classList.add('fa-pause');
                
                // In a real app, you would use the Audio API here
                // For demo, we'll just simulate playback
                simulateAudioPlayback(progress, duration);
            } else {
                // Pause audio
                icon.classList.remove('fa-pause');
                icon.classList.add('fa-play');
                
                // Stop simulation
                if (window.audioInterval) {
                    clearInterval(window.audioInterval);
                }
            }
        }

        function simulateAudioPlayback(progress, duration) {
            let currentTime = 0;
            const totalTime = 120; // 2 minutes for demo
            
            // Update duration text
            duration.textContent = formatTime(totalTime);
            
            if (window.audioInterval) {
                clearInterval(window.audioInterval);
            }
            
            window.audioInterval = setInterval(() => {
                currentTime += 1;
                const percent = (currentTime / totalTime) * 100;
                progress.style.width = percent + '%';
                
                if (currentTime >= totalTime) {
                    clearInterval(window.audioInterval);
                    const button = progress.closest('.audio-player').querySelector('.audio-play-button');
                    const icon = button.querySelector('i');
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                    progress.style.width = '0%';
                }
            }, 1000);
        }

        function seekAudio(progressBar, event) {
            const rect = progressBar.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const percent = (x / rect.width) * 100;
            const progress = progressBar.querySelector('.audio-progress-filled');
            progress.style.width = percent + '%';
            
            // In a real app, you would seek the audio to this position
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return mins + ':' + (secs < 10 ? '0' : '') + secs;
        }

        // Avatar gallery functions
        function openAvatarGallery() {
            // Close the avatar modal
            closeAvatarModal();
            
            // Trigger the file input for avatar selection
            document.getElementById('avatar-input').click();
        }

        function handleAvatarSelection(file) {
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Set the avatar to the selected image
                    const avatarElement = document.getElementById('profile-avatar');
                    avatarElement.style.backgroundImage = `url(${e.target.result})`;
                    avatarElement.textContent = '';
                    
                    // Save to settings
                    userSettings.avatar = 'custom';
                    saveUserSettings();
                    
                    // Close any open modals
                    closeAvatarModal();
                };
                reader.readAsDataURL(file);
            }
        }

        function openCamera() {
            // Close the avatar modal
            closeAvatarModal();
            
            // Show the camera modal
            document.getElementById('camera-modal').style.display = 'flex';
            
            // Access the device's camera
            initCamera();
        }

        function closeCamera() {
            document.getElementById('camera-modal').style.display = 'none';
            
            // Stop camera stream if it's running
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
        }

        function initCamera() {
            const video = document.getElementById('camera-video');
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(function(stream) {
                        cameraStream = stream;
                        video.srcObject = stream;
                    })
                    .catch(function(error) {
                        console.error('Camera error: ', error);
                        alert('Unable to access camera: ' + error.message);
                    });
            } else {
                alert('Your browser does not support camera access');
            }
        }

        function capturePhoto() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            const context = canvas.getContext('2d');
            
            // Set canvas dimensions to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw current video frame to canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert canvas to data URL
            const imageData = canvas.toDataURL('image/png');
            
            // Set the avatar to the captured photo
            const avatarElement = document.getElementById('profile-avatar');
            avatarElement.style.backgroundImage = `url(${imageData})`;
            avatarElement.textContent = '';
            
            // Save to settings
            userSettings.avatar = 'custom';
            saveUserSettings();
            
            // Close the camera
            closeCamera();
        }

        // YouTube download functions
        function fetchYouTubeInfo() {
            const url = document.getElementById('youtube-url').value.trim();
            
            if (!url) {
                showYouTubeError('Please enter a YouTube URL');
                return;
            }
            
            if (!isValidYouTubeUrl(url)) {
                showYouTubeError('Please enter a valid YouTube URL');
                return;
            }
            
            currentYouTubeUrl = url;
            
            // Show loading state
            document.getElementById('youtube-results').style.display = 'none';
            document.getElementById('youtube-downloading').style.display = 'flex';
            document.getElementById('youtube-download-status').textContent = 'Fetching video info...';
            document.getElementById('youtube-error').style.display = 'none';
            
            // Simulate API request
            simulateYouTubeInfoFetch(url);
        }

        function isValidYouTubeUrl(url) {
            const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.?be)\/.+$/;
            return youtubeRegex.test(url);
        }

        function simulateYouTubeInfoFetch(url) {
            // Simulate API request delay
            setTimeout(() => {
                // For demo purposes, we'll use a fake response
                const videoId = extractVideoId(url);
                const thumbnailUrl = `https://i.ytimg.com/vi/${videoId}/mqdefault.jpg`;
                
                document.getElementById('youtube-thumbnail').src = thumbnailUrl;
                document.getElementById('youtube-title').textContent = 'Sample YouTube Video';
                
                // Create download options
                const optionsContainer = document.getElementById('youtube-options');
                optionsContainer.innerHTML = '';
                
                // Audio options
                const audioOptions = [
                    { quality: '128kbps', format: 'MP3', size: '3.2 MB' },
                    { quality: '256kbps', format: 'MP3', size: '6.5 MB' },
                    { quality: '320kbps', format: 'MP3', size: '8.1 MB' }
                ];
                
                audioOptions.forEach(option => {
                    const optionElement = document.createElement('div');
                    optionElement.className = 'youtube-option';
                    optionElement.innerHTML = `
                        <div class="youtube-option-quality">${option.quality}</div>
                        <div class="youtube-option-size">${option.format} • ${option.size}</div>
                    `;
                    optionElement.onclick = () => downloadYouTubeAudio(option.quality);
                    optionsContainer.appendChild(optionElement);
                });
                
                // Video options
                const videoOptions = [
                    { quality: '720p', format: 'MP4', size: '15.7 MB' },
                    { quality: '1080p', format: 'MP4', size: '28.3 MB' },
                    { quality: '4K', format: 'MP4', size: '112.5 MB' }
                ];
                
                videoOptions.forEach(option => {
                    const optionElement = document.createElement('div');
                    optionElement.className = 'youtube-option';
                    optionElement.innerHTML = `
                        <div class="youtube-option-quality">${option.quality}</div>
                        <div class="youtube-option-size">${option.format} • ${option.size}</div>
                    `;
                    optionElement.onclick = () => downloadYouTubeVideo(option.quality);
                    optionsContainer.appendChild(optionElement);
                });
                
                // Show results
                document.getElementById('youtube-results').style.display = 'block';
                document.getElementById('youtube-downloading').style.display = 'none';
                
            }, 1500);
        }

        function extractVideoId(url) {
            const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[7].length === 11) ? match[7] : false;
        }

        function downloadYouTubeAudio(quality) {
            if (youtubeDownloadInProgress) return;
            
            youtubeDownloadInProgress = true;
            
            // Show downloading state
            document.getElementById('youtube-results').style.display = 'none';
            document.getElementById('youtube-downloading').style.display = 'flex';
            document.getElementById('youtube-download-status').textContent = `Downloading audio (${quality})...`;
            
            // Build API URL based on quality
            let apiUrl;
            if (quality === '128kbps') {
                apiUrl = `https://apis.davidcyriltech.my.id/download/ytmp3?url=${encodeURIComponent(currentYouTubeUrl)}`;
            } else {
                apiUrl = `https://apis.davidcyriltech.my.id/youtube/mp3?url=${encodeURIComponent(currentYouTubeUrl)}`;
            }
            
            // Simulate download progress
            simulateDownloadProgress(apiUrl, 'audio', quality);
        }

        function downloadYouTubeVideo(quality) {
            if (youtubeDownloadInProgress) return;
            
            youtubeDownloadInProgress = true;
            
            // Show downloading state
            document.getElementById('youtube-results').style.display = 'none';
            document.getElementById('youtube-downloading').style.display = 'flex';
            document.getElementById('youtube-download-status').textContent = `Downloading video (${quality})...`;
            
            // Build API URL
            const apiUrl = `https://apis.davidcyriltech.my.id/youtube/mp4?url=${encodeURIComponent(currentYouTubeUrl)}`;
            
            // Simulate download progress
            simulateDownloadProgress(apiUrl, 'video', quality);
        }

        function simulateDownloadProgress(apiUrl, type, quality) {
            let progress = 0;
            const progressBar = document.getElementById('youtube-download-bar');
            
            const progressInterval = setInterval(() => {
                progress += 5;
                progressBar.style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    youtubeDownloadInProgress = false;
                    
                    // Download complete
                    document.getElementById('youtube-download-status').textContent = 'Download complete!';
                    
                    // In a real app, you would actually download the file from the API
                    // For this demo, we'll simulate a successful download
                    setTimeout(() => {
                        // Send the downloaded media as a message
                        sendYouTubeDownloadMessage(type, quality);
                        
                        // Close the panel after a short delay
                        setTimeout(() => {
                            document.getElementById('youtube-panel').style.display = 'none';
                        }, 1000);
                    }, 1000);
                }
            }, 200);
        }

        function sendYouTubeDownloadMessage(type, quality) {
            if (!currentUser || !currentTargetUser) return;
            
            const messageData = {
                sender: currentUser,
                receiver: currentTargetUser,
                type: 'youtube',
                youtubeUrl: currentYouTubeUrl,
                mediaType: type,
                quality: quality,
                timestamp: new Date()
            };
            
            // Add to chat
            addYouTubeMessageToChat(messageData);
        }

        function addYouTubeMessageToChat(message) {
            const container = document.getElementById('private-messages-container');
            
            // Remove "no messages" system message if it exists
            const systemMessage = container.querySelector('.system-message');
            if (systemMessage && systemMessage.textContent.includes('No messages yet')) {
                systemMessage.remove();
            }
            
            const messageDiv = document.createElement('div');
            
            const isMyMessage = message.sender === currentUser;
            messageDiv.className = `message ${isMyMessage ? 'my-message' : 'their-message'}`;
            
            const videoId = extractVideoId(message.youtubeUrl);
            const thumbnailUrl = `https://i.ytimg.com/vi/${videoId}/mqdefault.jpg`;
            
            const time = new Date(message.timestamp).toLocaleTimeString([], { 
                hour: '2-digit', minute: '2-digit' 
            });
            
            let statusHtml = '';
            if (isMyMessage) {
                statusHtml = '<i class="fas fa-check"></i>';
            }
            
            messageDiv.innerHTML = `
                ${!isMyMessage ? `<div class="message-sender">${message.sender}</div>` : ''}
                <div class="youtube-message">
                    <div class="youtube-message-header">
                        <i class="fab fa-youtube youtube-message-icon"></i>
                        <div class="youtube-message-title">YouTube ${message.mediaType === 'audio' ? 'Audio' : 'Video'} Download</div>
                    </div>
                    <div class="youtube-message-url">${message.youtubeUrl}</div>
                    <div class="youtube-message-actions">
                        <button class="youtube-message-button" onclick="openYouTubeUrl('${message.youtubeUrl}')">
                            <i class="fas fa-external-link-alt"></i> Open
                        </button>
                        <button class="youtube-message-button" onclick="redownloadYouTube('${message.youtubeUrl}', '${message.mediaType}', '${message.quality}')">
                            <i class="fas fa-download"></i> Download Again
                        </button>
                    </div>
                </div>
                <div class="message-time">${time} ${statusHtml}</div>
            `;
            
            container.appendChild(messageDiv);
            
            // Make sure typing indicator stays at the bottom
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                container.appendChild(typingIndicator);
            }
            
            container.scrollTop = container.scrollHeight;
        }

        function openYouTubeUrl(url) {
            window.open(url, '_blank');
        }

        function redownloadYouTube(url, mediaType, quality) {
            // Open YouTube panel with the URL
            document.getElementById('youtube-panel').style.display = 'flex';
            document.getElementById('youtube-url').value = url;
            currentYouTubeUrl = url;
            
            // Fetch info
            fetchYouTubeInfo();
            
            // After a delay, automatically select the previous quality
            setTimeout(() => {
                if (mediaType === 'audio') {
                    downloadYouTubeAudio(quality);
                } else {
                    downloadYouTubeVideo(quality);
                }
            }, 2000);
        }

        function showYouTubeError(message) {
            const errorElement = document.getElementById('youtube-error');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        // Gram X Music Downloader functions
        function searchMusic() {
            const query = document.getElementById('music-search-input').value.trim();
            
            if (!query) {
                showMusicError('Please enter a song name to search');
                return;
            }
            
            // Show loading state
            document.getElementById('music-results').style.display = 'none';
            document.getElementById('music-downloading').style.display = 'flex';
            document.getElementById('music-download-status').textContent = 'Searching for songs...';
            document.getElementById('music-error').style.display = 'none';
            
            // Simulate API request
            simulateMusicSearch(query);
        }

        function simulateMusicSearch(query) {
            // Simulate API request delay
            setTimeout(() => {
                // For demo purposes, we'll use fake results
                const resultsContainer = document.getElementById('music-results');
                resultsContainer.innerHTML = '';
                
                // Sample music results
                const sampleResults = [
                    { id: 1, title: 'Popular Song 1', artist: 'Artist A', duration: '3:45', size: '3.2 MB' },
                    { id: 2, title: 'Popular Song 2', artist: 'Artist B', duration: '4:12', size: '4.1 MB' },
                    { id: 3, title: 'Popular Song 3', artist: 'Artist C', duration: '2:58', size: '2.8 MB' },
                    { id: 4, title: query, artist: 'Searched Artist', duration: '3:30', size: '3.5 MB' }
                ];
                
                sampleResults.forEach(song => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'music-result-item';
                    resultItem.innerHTML = `
                        <div style="width: 60px; height: 60px; border-radius: 8px; background: linear-gradient(135deg, #6a11cb 0%, #4a08a3 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                            <i class="fas fa-music"></i>
                        </div>
                        <div class="music-info">
                            <div class="music-title">${song.title}</div>
                            <div class="music-artist">${song.artist} • ${song.duration}</div>
                        </div>
                        <button class="music-download-button" onclick="downloadMusic(${song.id}, '${song.title}', '${song.artist}')">
                            <i class="fas fa-download"></i>
                        </button>
                    `;
                    resultsContainer.appendChild(resultItem);
                });
                
                // Show results
                document.getElementById('music-results').style.display = 'block';
                document.getElementById('music-downloading').style.display = 'none';
                
            }, 1500);
        }

        function downloadMusic(songId, title, artist) {
            if (musicDownloadInProgress) return;
            
            musicDownloadInProgress = true;
            
            // Show downloading state
            document.getElementById('music-results').style.display = 'none';
            document.getElementById('music-downloading').style.display = 'flex';
            document.getElementById('music-download-status').textContent = `Downloading ${title} by ${artist}...`;
            
            // Simulate download progress
            simulateMusicDownload(songId, title, artist);
        }

        function simulateMusicDownload(songId, title, artist) {
            let progress = 0;
            const progressBar = document.getElementById('music-download-bar');
            
            const progressInterval = setInterval(() => {
                progress += 5;
                progressBar.style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    musicDownloadInProgress = false;
                    
                    // Download complete
                    document.getElementById('music-download-status').textContent = 'Download complete!';
                    
                    // In a real app, you would actually download the file
                    // For this demo, we'll simulate a successful download
                    setTimeout(() => {
                        // Save to device
                        saveMusicToDevice(title, artist);
                        
                        // Reset after a short delay
                        setTimeout(() => {
                            document.getElementById('music-downloading').style.display = 'none';
                            document.getElementById('music-results').style.display = 'block';
                        }, 1000);
                    }, 1000);
                }
            }, 200);
        }

        function saveMusicToDevice(title, artist) {
            // In a real app, you would save the actual music file to the device
            // For this demo, we'll simulate saving to device storage
            alert(`"${title}" by ${artist} has been saved to your device!`);
            
            // You would typically use something like:
            // const a = document.createElement('a');
            // a.href = musicBlobUrl;
            // a.download = `${title} - ${artist}.mp3`;
            // document.body.appendChild(a);
            // a.click();
            // document.body.removeChild(a);
        }

        function showMusicError(message) {
            const errorElement = document.getElementById('music-error');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        // Initialize media features
        function initializeMediaFeatures() {
            setupFileInputListeners();
            
            // Close media panel when clicking outside
            document.addEventListener('click', (e) => {
                const mediaPanel = document.getElementById('media-attachment-panel');
                const youtubePanel = document.getElementById('youtube-panel');
                
                if (mediaPanel.style.display === 'flex' && 
                    !e.target.closest('.media-attachment-panel') && 
                    !e.target.closest('.input-button')) {
                    mediaPanel.style.display = 'none';
                }
                
                if (youtubePanel.style.display === 'flex' && 
                    !e.target.closest('.media-attachment-panel') && 
                    !e.target.closest('.youtube-button')) {
                    youtubePanel.style.display = 'none';
                }
            });
        }

        // Initialize the app when page loads
        window.onload = function() {
            // Check if user was previously logged in
            const savedUser = localStorage.getItem('gramx_current_user');
            if (savedUser) {
                document.getElementById('login-username').value = savedUser;
                currentUser = savedUser;
                initializeSocket();
                showScreen('chat-list-screen');
            }
            
            // Set up tab click handlers
            document.querySelectorAll('.tab').forEach((tab, index) => {
                tab.addEventListener('click', () => {
                    if (index === 0) showTab('conversations');
                    else if (index === 1) showTab('online');
                    else if (index === 2) loadAllUsers();
                });
            });

            // Set up bottom navigation
            document.querySelectorAll('.nav-item').forEach((item, index) => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                    
                    if (index === 0) {
                        showScreen('chat-list-screen');
                        showTab('conversations');
                    } else if (index === 1) {
                        showScreen('chat-list-screen');
                        showTab('online');
                    } else if (index === 2) {
                        showSettings();
                    }
                });
            });

            // Check for system theme preference
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
            if (prefersDark.matches) {
                document.body.classList.add('dark-theme');
            }
            
            // Listen for system theme changes
            prefersDark.addEventListener('change', e => {
                const savedSettings = localStorage.getItem(`gramx_settings_${currentUser}`);
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    if (settings.theme === 'auto') {
                        applyTheme('auto');
                    }
                }
            });
            
            // Initialize media features
            initializeMediaFeatures();
        };
    </script>
</body>
</html>
